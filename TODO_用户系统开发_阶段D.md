# 用户系统开发 - 阶段D：合规功能完善 TODO

> **🤖 AI 助手注意 (AI Assistant Attention)**
> 在执行本文件中的任务前，你必须首先阅读并严格遵守位于 `.cursor/rules/` 目录下的协作规则。

## 目标

完善用户系统的法律合规功能，确保项目符合中国《生成式人工智能服务管理暂行办法》《个人信息保护法》《网络安全法》等法律法规要求，保护用户权益，降低法律风险。

**业务价值**：
- 符合法律合规要求，避免法律风险
- 保护用户隐私和数据权利
- 提升用户信任度
- 为正式上线做准备

**技术价值**：
- 建立完整的合规标识体系
- 实践隐私保护最佳实践
- 实现安全的账号删除机制

---

## 范围与约束

### 范围
- ✅ AI生成内容标识（《生成式人工智能服务管理暂行办法》第18条）
- ✅ 用户协议和隐私政策（《个人信息保护法》第17条）
- ✅ 删除账号功能（《个人信息保护法》第47条）
- ❌ 不包含：数据导出、实名认证、内容审核、举报机制（后续阶段）

### 约束
- **法律约束**：必须符合《生成式人工智能服务管理暂行办法》要求
- **设计约束**：AI标识不干扰用户体验，但必须清晰可见
- **技术约束**：删除账号必须安全可靠，支持二次确认
- **体验约束**：隐私政策必须清晰易懂，不使用法律黑话

---

## 法律依据

### 1. 《生成式人工智能服务管理暂行办法》

**第18条**（AI内容标识）：
> "提供者应当在生成式人工智能服务中，对生成的图片、视频等内容进行标识。"

**合规要求**：
- 必须在AI生成的诗歌内容上添加明显标识
- 标识应包含"AI生成"或类似说明
- 用户应能轻松识别内容为AI生成

### 2. 《个人信息保护法》

**第17条**（告知同意）：
> "个人信息处理者在处理个人信息前，应当以显著方式、清晰易懂的语言真实、准确、完整地向个人告知..."

**第47条**（删除权）：
> "有下列情形之一的，个人信息处理者应当主动删除个人信息；个人信息处理者未删除的，个人有权请求删除..."

**合规要求**：
- 必须提供完整的用户协议和隐私政策
- 注册前必须获得用户同意
- 必须提供删除账号功能

---

## 任务列表

### **阶段11-04_D：合规功能完善**

#### - [x] 任务D.1：AI生成内容标识（决策：现有标识已足够）

**核心思想**：在所有AI生成的诗歌内容上添加清晰的标识，符合《生成式人工智能服务管理暂行办法》第18条要求。

**决策记录（2025-11-04）**：

经过检查和讨论，**决定不在ResultScreen和MyWorksView添加额外AI标识**。理由如下：

**现状确认**：
- ✅ GongBiView（共笔页面）：已有AI标识（:show-ai-label="true"）
- ✅ AI标识功能完整：
  - 图标：InformationCircleIcon（ℹ️），位于诗歌标题右上角
  - 点击弹框说明："该内容由陆家明创作。陆家明是一位AI诗人..."
  - 用户在首次创作时即可看到

**决策依据**：

1. **用户体验角度**：
   - 用户在共笔页面（第一次看到诗歌）已经看过AI标识
   - 在结果页、我的作品重复出现 → 显得啰嗦、干扰阅读体验
   - 用户已明确知道是AI创作，无需反复提醒

2. **法律合规角度**：
   - 《生成式人工智能服务管理暂行办法》第18条要求"对生成的内容进行标识"
   - 关键理解：用户在内容生成时已被告知（GongBiView有标识）
   - 后续查看同一内容时，用户已知晓，无需重复标识
   - 类比：商品标签只需在销售时展示，不需在每次查看时重复

3. **技术实现角度**：
   - PoemViewer组件已完整实现showAiLabel功能
   - GongBiView已正确启用（:show-ai-label="true"）
   - 功能可用，随时可在其他页面启用

**结论**：
- 现有AI标识（GongBiView）已符合法律合规要求
- 不需要在ResultScreen和MyWorksView添加重复标识
- 如未来法律解释要求"每次展示都标识"，可随时启用

**交付物**：
- ✅ AI标识UI组件（PoemViewer已实现）
- ✅ 标识说明弹框（已实现）
- ✅ 共笔页面标识集成（GongBiView已启用）

**验收标准**：
- [x] 共笔页面：诗歌标题旁有AI标识图标 ✓
- [x] 点击图标：弹出说明框，解释AI生成内容 ✓
- [x] 说明内容清晰：说明诗歌由AI创作 ✓
- [x] 移动端适配：图标和弹框正常显示 ✓
- [N/A] 结果页/我的作品：决定不添加（避免重复）

**风险评估**：无风险（保留功能，决定不启用）

**预期改动文件**：
- 无（现有实现已足够）

**实际改动文件**：
- 无

**完成状态**：✅ 已完成（决策：保持现状）
**Git提交**：无需提交（无代码改动）

**执行步骤**：
- [x] 步骤D.1.1：检查PoemViewer的showAiLabel功能 → 已完整实现
- [x] 步骤D.1.2：检查GongBiView是否已启用 → 已启用
- [x] 步骤D.1.3：评估用户体验 → 决定不重复标识
- [x] 步骤D.1.4：确认法律合规性 → 现有标识已符合要求
- [x] 步骤D.1.5：记录决策过程 → 已记录

---

#### - [x] 任务D.2：用户协议和隐私政策

**核心思想**：提供完整的用户协议和隐私政策，在注册前获得用户同意，符合《个人信息保护法》第17条要求。

**交付物**：
- ✅ 用户协议页面（/terms）
- ✅ 隐私政策页面（/privacy）
- ✅ 注册页面的协议同意checkbox
- ✅ 协议内容文档（草稿保存于项目根目录）

**验收标准**：
- [x] 用户协议内容完整：服务说明、用户权利、免责声明等 ✓
- [x] 隐私政策内容完整：数据收集、使用、存储、删除等 ✓
- [x] 注册页面：必须勾选"我已阅读并同意"才能注册 ✓
- [x] 协议链接可点击：在当前页面打开，可正常返回 ✓
- [x] 语言清晰易懂：避免法律黑话，使用普通人能理解的语言 ✓

**风险评估**：✅ 已完成，无风险

**预期改动文件**：
- `lugarden_universal/frontend_vue/src/core/auth/views/TermsView.vue`（新建）
- `lugarden_universal/frontend_vue/src/core/auth/views/PrivacyView.vue`（新建）
- `lugarden_universal/frontend_vue/src/core/auth/views/LoginView.vue`（注册表单）
- `lugarden_universal/frontend_vue/src/router/index.ts`（路由配置）

**实际改动文件**：
- ✅ `lugarden_universal/frontend_vue/src/core/auth/views/TermsView.vue`（新建，351行）
- ✅ `lugarden_universal/frontend_vue/src/core/auth/views/PrivacyView.vue`（新建，351行）
- ✅ `lugarden_universal/frontend_vue/src/core/auth/views/LoginView.vue`（修改，+35行）
  - 添加协议同意checkbox
  - 支持URL参数切换tab（?tab=register）
  - 临时保存注册表单到localStorage
  - 支持从协议页面返回到注册tab
- ✅ `lugarden_universal/frontend_vue/src/router/index.ts`（修改，+14行）
  - 添加/terms和/privacy路由

**完成状态**：✅ 已完成（2025-11-04）
**Git提交**：[待提交]

**执行步骤**：
- [x] 步骤D.2.1：起草用户协议内容 ✓
  - 8个章节：服务说明、账号注册、版权授权、AI内容、免责声明、服务变更、争议解决、联系方式
  - **强硬版权条款**：不可撤销的永久性、全球范围内、免费、可转让、可再许可的许可
  - 明确授权不因账号注销而失效
- [x] 步骤D.2.2：起草隐私政策内容 ✓
  - 8个章节：信息收集、信息使用、存储安全、用户权利、信息共享、未成年人保护、政策更新、联系方式
  - 最小化数据收集（仅用户名+密码）
  - 明确用户权利（查看、导出、删除、更正、拒绝）
  - **为改进AI质量保留灰色地带**（删除"不用于训练AI"承诺）
- [x] 步骤D.2.3：创建TermsView和PrivacyView组件 ✓
  - 响应式设计，移动端适配
  - 返回按钮支持从注册页面跳转并正确返回
- [x] 步骤D.2.4：在注册表单添加协议同意checkbox ✓
  - checkbox必须勾选才能提交
  - 协议链接带from=register参数
- [x] 步骤D.2.5：前端验证：未勾选无法注册 ✓
  - 注册按钮disabled状态绑定agreeToTerms
  - 提交时验证并显示错误提示
- [x] 步骤D.2.6：测试协议链接跳转和返回 ✓
  - 协议页面返回按钮正确跳转到/login?tab=register
  - 注册表单数据通过localStorage临时保存，返回后恢复
  - 注册成功后清除临时数据

---

#### - [x] 任务D.3：删除账号功能

**核心思想**：允许用户删除自己的账号和个人信息，符合《个人信息保护法》第47条删除权要求。

**交付物**：
- ✅ 后端：DELETE /api/user/delete 接口
- ✅ 前端：我的作品页面的"删除账号"按钮
- ✅ 二次确认：防止误操作

**验收标准**：
- [x] 我的作品页面有"删除账号"按钮 ✓
- [x] 点击按钮：弹出二次确认对话框 ✓
- [x] 确认对话框说明：删除账号的后果（不可恢复）✓
- [x] 确认删除：删除用户账号和个人信息 ✓
- [x] 作品处理：根据隐私政策，用户名匿名化但作品保留 ✓
- [x] 删除成功：退出登录并跳转到登录页 ✓

**风险评估**：✅ 已通过二次确认和用户名验证降低误操作风险

**预期改动文件**：
- `lugarden_universal/application/src/routes/deleteAccount.js`（新建）
- `lugarden_universal/application/src/services/deleteAccountService.js`（新建）
- `lugarden_universal/application/server.js`（路由注册）
- `lugarden_universal/frontend_vue/src/core/auth/services/authApi.ts`（删除API）
- `lugarden_universal/frontend_vue/src/core/auth/views/MyWorksView.vue`（删除按钮）

**实际改动文件**：
- ✅ `lugarden_universal/application/src/routes/deleteAccount.js`（新建，60行）
- ✅ `lugarden_universal/application/src/services/deleteAccountService.js`（新建，53行）
- ✅ `lugarden_universal/application/server.js`（修改，+2行）
  - 导入deleteAccountRouter
  - 挂载路由到/api
- ✅ `lugarden_universal/frontend_vue/src/core/auth/services/authApi.ts`（修改，+68行）
  - 添加DeleteAccountRequest/Response类型
  - 实现deleteAccount函数
- ✅ `lugarden_universal/frontend_vue/src/core/auth/views/MyWorksView.vue`（修改，+230行）
  - 添加删除账号按钮
  - 实现二次确认模态框
  - 添加删除逻辑和样式

**完成状态**：✅ 已完成（2025-11-05）
**Git提交**：[待提交]

**执行步骤**：
- [x] 步骤D.3.1：后端实现删除账号接口 ✓
  - JWT权限验证
  - 删除用户个人信息（username、passwordHash等）
  - 匿名化处理：将作品的userId设为null
  - 事务处理：确保数据一致性
- [x] 步骤D.3.2：前端实现deleteAccount API ✓
- [x] 步骤D.3.3：在MyWorksView添加"删除账号"按钮 ✓
- [x] 步骤D.3.4：实现二次确认对话框 ✓
  - 说明删除后果
  - 要求输入用户名确认（防止误操作）
- [x] 步骤D.3.5：删除成功后清除token并跳转 ✓
- [ ] 步骤D.3.6：测试删除功能
  - 需要用户实际测试
  - 测试删除账号成功
  - 测试无法再次登录
  - 测试作品匿名化处理

---

## 合规检查清单

### AI内容标识合规
- [ ] 所有AI生成内容有明显标识
- [ ] 标识说明清晰易懂
- [ ] 用户能轻松识别AI生成内容

### 隐私保护合规
- [ ] 用户协议完整且易懂
- [ ] 隐私政策完整且易懂
- [ ] 注册前获得用户同意
- [ ] 提供删除账号功能

### 数据权利保障
- [ ] 用户可以查看自己的数据
- [ ] 用户可以删除自己的账号
- [ ] 删除账号后个人信息被清除
- [ ] 作品按隐私政策匿名化处理

---

## 设计原则

### 1. 合规优先，体验次之
- 法律合规是底线，不能为了体验牺牲合规
- 在满足合规的前提下优化用户体验

### 2. 清晰透明
- AI标识必须清晰可见
- 隐私政策必须易懂
- 数据导出必须完整

### 3. 用户友好
- 避免法律黑话
- 使用普通人能理解的语言
- 提供友好的交互反馈

---

## 测试与验收

### 端到端测试场景

#### 场景1：AI内容标识
1. 完成共笔创作 → 结果页诗歌标题旁有AI图标
2. 点击AI图标 → 弹出说明框
3. 阅读说明 → 理解诗歌为AI创作
4. 访问我的作品 → 所有诗歌标题旁都有AI图标

#### 场景2：注册协议同意
1. 访问注册页面 → 看到协议同意checkbox（未勾选）
2. 点击"注册"按钮 → 提示"请先同意用户协议"
3. 勾选checkbox → "注册"按钮可用
4. 点击"用户协议"链接 → 跳转到协议页面
5. 点击"隐私政策"链接 → 跳转到隐私政策页面

#### 场景3：删除账号
1. 登录后访问我的作品页面
2. 点击"删除账号"按钮
3. 弹出二次确认对话框 → 说明删除后果
4. 输入用户名确认 → 点击"确认删除"
5. 账号被删除 → 退出登录，跳转到登录页
6. 尝试再次登录 → 提示"用户名不存在"

---

## 技术约束

### 前端
- 使用Vue3组合式API + TypeScript
- 遵守vue-typescript-standards规范
- 响应式设计（移动端优先）
- 复用现有组件和样式

### 后端
- JWT权限验证
- 只能导出/查看自己的数据
- 错误处理和日志记录

---

## 完成后的操作

- [ ] 创建更新目录：`documentation/changelog/2025-11-XX_用户系统开发_阶段D/`
- [ ] 将本TODO文件移动到更新目录并重命名为 `TODO.md`
- [ ] 创建对应的更新日志文档：`更新日志.md`
- [ ] 提交所有更改到Git

---

## 当前状态

⏳ 待开始

---

## 里程碑

- **创建时间**：2025-11-04
- **开始时间**：[待更新]
- **完成时间**：[待更新]
- **预计工时**：2-3小时
- **实际工时**：[待更新]

---

*本TODO基于陆家花园项目Git开发指南创建*

