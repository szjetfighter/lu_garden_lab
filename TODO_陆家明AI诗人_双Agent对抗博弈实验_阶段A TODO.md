# 陆家明AI诗人_双Agent对抗博弈实验_阶段A TODO（增强版）

> **🤖 AI 助手注意 (AI Assistant Attention)**
> 在执行本文件中的任何任务前，你必须首先阅读并严格遵守位于 `documentation/ai-collaboration-guide.md` 的全局协作指南。

## ⚠️ 技术路线重大调整说明

### 📋 **调整背景**
在阶段A技术选型完成后，我们曾尝试向更复杂的Vertex AI Agent Builder技术路线演进，试图通过托管式AI服务实现双Agent对抗博弈架构。

### 🚫 **实际遇到的技术阻碍**
经过实际验证，我们发现以下关键技术问题：

1. **Vertex AI Agent使用门槛过高**: Google Vertex AI Agent Builder的学习成本和操作复杂度超出预期，不符合项目"快速验证方法论"的核心目标
2. **数据格式兼容性问题**: Google无法解析项目的JSON/JSONL知识库文件，且其数据格式规范不明确，严重阻碍知识库构建
3. **模型能力限制**: Vertex AI Agent当前不支持Gemini 2.5 Pro，无法使用最新的模型能力

### 🔄 **决策调整原则**
基于**"保持核心创新，简化技术实现"**的原则，我们决定：
- **保留**: 双Agent对抗博弈的核心方法论（项目的真正价值所在）
- **回归**: 阶段A确定的务实技术路线（Express + LangChain + Gemini直接API）
- **目标**: 聚焦方法论验证，而非技术复杂度展示

---

## 目标

基于用户端对抗优化方法论，在 Dify 平台内构建最小可行的双Agent对抗博弈实验系统，验证基于prompt博弈的对抗优化方法论的技术可行性。核心实验内容：在Dify工作流中实现Generator Agent（诗人陆家明）与Discriminator Agent（批评家）的动态对抗循环，建立结构化输出与引文核验机制，形成可分享、可通过API调用的理论验证原型。

**业务价值**：
- 为陆家花园项目提供可验证的AI诗人服务原型
- 验证现代诗人风格模仿和检测的技术能力
- 建立具有理论贡献价值的AI内容生产系统最小演示

**技术价值**：
- 实证基于prompt博弈的对抗优化方法论的有效性
- 验证Dify平台在复杂AI系统构建中的工程价值
- 建立可复制的小团队AI内容生产解决方案
- 形成可导出/导入的DSL资产和最佳实践

## 范围与约束

- **技术基础**: 基于Dify平台的工作流构建能力，使用Chatflow/Workflow、知识库、LLM节点、条件分支等
- **资源约束**: 单人实验团队，基于Dify云服务或社区版，无需本地代码开发
- **验证范围**: 以最小可行原型验证对抗博弈方法论，重点关注结构化输出与引文核验
- **兼容性约束**: 形成可导出的DSL资产，便于后续本地系统集成

## 任务列表

> **任务编号规范**
> - 阶段2025-08-31_A使用前缀"A"：任务A.1、任务A.2、任务A.3 …；步骤使用"A.1.x"、"A.2.x"的三级编号

---

### **阶段08-31_A：双Agent对抗博弈实验系统构建**

#### - [ ] 任务A.1：知识库架构设计与构建
- **核心思想**: 在Dify内构建支撑对抗博弈的知识库架构，实现风格域与正典域的分离，为Generator和Discriminator提供差异化的检索支持
- **实施内容**:
  - 设计风格域知识库（项目语料/吴任几风格）与正典域知识库（《周易》《春秋公羊传》《孟子》全域）
  - 配置检索权重与重排策略（向量/关键词混合，top_k调优）
  - 验证检索召回质量与引用归属功能
- 交付物：
  - [ ] **知识库架构方案**: 风格域与正典域的分离设计文档
  - [ ] **检索配置策略**: 向量/关键词权重与重排参数优化
  - [ ] **召回质量验证**: 基于样本查询的检索效果评估
- 验收标准：
  - [ ] 成功创建并配置风格域与正典域两个独立知识库
  - [ ] 验证检索召回的相关性与引用归属的准确性
  - [ ] 确认检索配置可支撑后续G/D节点的上下文需求
- **风险评估**: 中风险 - 知识库质量直接影响对抗效果
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 实验文档与配置记录
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.1.1：设计知识库分域架构（风格域vs正典域）
  - [ ] 步骤A.1.2：在Dify内创建并配置知识库
  - [ ] 步骤A.1.3：优化检索权重与重排参数
  - [ ] 步骤A.1.4：验证召回质量与引用归属

#### - [ ] 任务A.2：双Agent工作流架构实现
- **核心思想**: 在Dify工作流中构建Generator Agent与Discriminator Agent的对抗循环，实现创作→评估→迭代的完整闭环，支持最多3轮优化迭代
- **实施内容**:
  - 设计Chatflow/Workflow拓扑：Start → 知识检索 → G → D → If/Else → 迭代/Answer
  - 配置G（生成器）与D（判别器）的LLM节点与提示策略
  - 实现基于条件分支的迭代控制逻辑（≤3轮，末轮兜底）
  - 建立节点间的变量传递与上下文管理
- 交付物：
  - [ ] **工作流拓扑设计**: G/D对抗循环的完整节点图
  - [ ] **LLM节点配置**: G与D的角色定义、提示模板与参数设置
  - [ ] **迭代控制逻辑**: 条件分支与循环次数管理机制
  - [ ] **变量传递方案**: 节点间数据流与上下文管理
- 验收标准：
  - [ ] 成功构建包含G/D/If-Else的完整工作流
  - [ ] 验证最多3轮迭代逻辑与末轮兜底机制
  - [ ] 确认节点间变量传递与上下文注入正常
- **风险评估**: 高风险 - 核心对抗逻辑的复杂性与稳定性
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 工作流配置与实验记录
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.2.1：设计双Agent工作流拓扑结构
  - [ ] 步骤A.2.2：配置Generator Agent的LLM节点与提示
  - [ ] 步骤A.2.3：配置Discriminator Agent的LLM节点与提示
  - [ ] 步骤A.2.4：实现条件分支与迭代控制逻辑

#### - [ ] 任务A.3：结构化输出与路由稳健性
- **核心思想**: 建立Discriminator的结构化输出规范与稳健的路由机制，确保"发表/驳回"决策的可靠解析，避免路由脆弱性问题
- **实施内容**:
  - 设计D的结构化输出模板（行首键名固定）
  - 实现基于精确匹配的If/Else路由逻辑
  - 建立软指标输出（风格保真度、证据充足度）与错误码机制
  - 验证路由在噪声与边界情况下的稳定性
- 交付物：
  - [ ] **结构化输出模板**: D的标准化输出格式与键名规范
  - [ ] **路由配置方案**: If/Else的精确匹配逻辑与容错机制
  - [ ] **软指标设计**: 风格保真度与证据充足度的输出规范
  - [ ] **稳定性测试**: 边界情况与噪声输入的路由验证
- 验收标准：
  - [ ] D输出严格遵循行首键名格式，仅第一行包含"发表/驳回"
  - [ ] If/Else路由基于精确匹配，避免关键字误触发
  - [ ] 软指标输出格式统一，支持后续量化分析
- **风险评估**: 中风险 - 路由稳定性直接影响系统可靠性
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 输出规范与测试记录
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.3.1：设计D的结构化输出模板与键名规范
  - [ ] 步骤A.3.2：配置If/Else的精确匹配路由逻辑
  - [ ] 步骤A.3.3：实现软指标输出与错误码机制
  - [ ] 步骤A.3.4：验证路由在边界情况下的稳定性

#### - [ ] 任务A.4：引文核验机制与正典域校验
- **核心思想**: 建立基于"唯一正典语料库"的引文核验机制，实现D对引文真实性的刚性校验，确保"选择自由，验证刚性"的方法论落地
- **实施内容**:
  - 设计引文核验的检索策略（仅在正典域查证）
  - 建立规范化命名与近似匹配规则
  - 实现未命中→不合规→驳回的硬门槛逻辑
  - 验证引文核验的准确性与覆盖度
- 交付物：
  - [ ] **引文核验策略**: 基于正典域的检索与匹配规则
  - [ ] **命名规范标准**: 周易/公羊传/孟子的统一命名格式
  - [ ] **硬门槛逻辑**: 未命中引文的强制驳回机制
  - [ ] **核验准确性验证**: 基于样本的引文校验效果评估
- 验收标准：
  - [ ] D仅在正典域核验"书目·篇章+原句/近似断句"
  - [ ] 未在正典域命中的引文直接判为"不合规"并"驳回"
  - [ ] 规范化命名与近似匹配规则覆盖主要变体
- **风险评估**: 高风险 - 引文核验的准确性直接影响方法论可信度
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 核验规则与测试样本
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.4.1：设计基于正典域的引文核验策略
  - [ ] 步骤A.4.2：建立规范化命名与近似匹配规则
  - [ ] 步骤A.4.3：实现未命中引文的硬门槛驳回逻辑
  - [ ] 步骤A.4.4：验证引文核验的准确性与覆盖度

#### - [ ] 任务A.5：API访问与DSL资产化
- **核心思想**: 建立实验系统的API访问能力与DSL资产导出机制，确保原型可通过程序化方式调用，并可导出为可复用的配置资产
- **实施内容**:
  - 配置应用API访问与认证机制
  - 验证API调用与控制台操作的一致性
  - 实现DSL导出与跨环境导入验证
  - 建立分享链接与外部访问能力（如适用）
- 交付物：
  - [ ] **API访问配置**: 应用API Key生成与调用验证
  - [ ] **一致性测试**: API与控制台行为的对比验证
  - [ ] **DSL资产**: 可导出/导入的工作流配置文件
  - [ ] **跨环境验证**: DSL在不同Dify环境下的可用性测试
- 验收标准：
  - [ ] 成功生成应用API Key并通过REST API触发工作流
  - [ ] API调用结果与控制台操作完全一致
  - [ ] DSL导出成功，跨环境导入后按指引可正常运行
- **风险评估**: 低风险 - 主要是平台功能的标准化使用
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - API测试记录与DSL文件
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.5.1：配置应用API访问与认证
  - [ ] 步骤A.5.2：验证API调用与控制台的一致性
  - [ ] 步骤A.5.3：实现DSL导出与资产化
  - [ ] 步骤A.5.4：验证DSL跨环境导入可用性

#### - [ ] 任务A.6：实验效果评估与方法论验证
- **核心思想**: 建立对抗博弈实验的效果评估体系，通过定量与定性指标验证基于prompt博弈的对抗优化方法论的实际效果
- **实施内容**:
  - 设计实验评估指标（迭代收敛率、质量提升度、稳定性）
  - 实施多轮对抗实验与数据收集
  - 分析Generator与Discriminator的对抗效果
  - 形成方法论验证结论与改进建议
- 交付物：
  - [ ] **评估指标体系**: 定量与定性的方法论效果评估标准
  - [ ] **实验数据集**: 多轮对抗实验的完整记录与分析
  - [ ] **效果分析报告**: Generator/Discriminator对抗效果的深度分析
  - [ ] **方法论验证结论**: 基于实验数据的理论可行性评估
- 验收标准：
  - [ ] 完成至少10轮完整的对抗博弈实验循环
  - [ ] 建立量化的迭代收敛与质量提升评估体系
  - [ ] 形成基于数据的方法论可行性结论
- **风险评估**: 高风险 - 实验效果直接决定方法论价值
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 实验数据与分析报告
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.6.1：设计实验评估指标与数据收集方案
  - [ ] 步骤A.6.2：实施多轮对抗博弈实验
  - [ ] 步骤A.6.3：分析Generator与Discriminator的对抗效果
  - [ ] 步骤A.6.4：形成方法论验证结论与改进建议

---

## 测试与验收
- 每个任务都需要有明确的技术验收标准和质量评估方法
- 需要进行双Agent系统的功能测试和对抗循环验证
- 需要验证方法论有效性的定量和定性评估
- 需要确保DSL资产的可导出性和跨环境可用性
- 重点验证Dify平台构建复杂AI系统的稳定性和可维护性

## 更新日志关联
- **预计更新类型**: 双Agent对抗博弈实验系统开发/方法论验证（基于Dify平台）
- **更新目录**: `documentation/changelog/2025-08-31_陆家明AI诗人双Agent对抗博弈实验完成/`
- **更新日志文件**: `更新日志.md`
- **测试验证点**: 
  - [ ] 双Agent对抗循环功能完整性验证（基于Dify工作流）
  - [ ] 对抗博弈方法论有效性验证（结构化输出与引文核验）
  - [ ] 知识库检索与核验机制性能验证
  - [ ] API访问与DSL资产化验证

## 注意事项
- 本阶段基于Dify平台能力，专注于理论验证而非工程实现
- 重点关注方法论验证而非技术复杂度展示，聚焦核心创新价值
- 基于Dify云服务或社区版进行成本控制，API调用成本透明
- 保持实验记录清晰，每个任务完成后单独记录
- 每个技术实现都要有充分的文档和测试用例
- 确保双Agent系统基于Dify平台的稳定性和可复现性
- 充分利用Dify的工作流、知识库、API等成熟功能，降低技术风险

## 完成后的操作
- [ ] 创建更新目录：`documentation/changelog/2025-08-31_陆家明AI诗人双Agent对抗博弈实验完成/`
- [ ] 将本TODO文件移动到更新目录并重命名为 `TODO.md`
- [ ] 创建对应的更新日志文档：`更新日志.md`
- [ ] 提交所有更改到Git
- [ ] 准备下一阶段的本地系统集成工作

## 当前状态
🔄 进行中 - 基于Dify平台的双Agent对抗博弈实验系统构建，专注方法论理论验证，共6个核心任务

---
*本TODO基于陆家花园项目Git开发指南格式创建，专注于基于Dify平台的双Agent对抗博弈实验验证*