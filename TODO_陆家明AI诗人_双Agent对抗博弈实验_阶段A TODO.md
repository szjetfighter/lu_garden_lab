# 陆家明AI诗人_双Agent对抗博弈实验_阶段A TODO（增强版）

> **🤖 AI 助手注意 (AI Assistant Attention)**
> 在执行本文件中的任何任务前，你必须首先阅读并严格遵守位于 `documentation/ai-collaboration-guide.md` 的全局协作指南。

## ⚠️ 技术路线重大调整说明

### 📋 **调整背景**
在阶段A技术选型完成后，我们曾尝试向更复杂的Vertex AI Agent Builder技术路线演进，试图通过托管式AI服务实现双Agent对抗博弈架构。

### 🚫 **实际遇到的技术阻碍**
经过实际验证，我们发现以下关键技术问题：

1. **Vertex AI Agent使用门槛过高**: Google Vertex AI Agent Builder的学习成本和操作复杂度超出预期，不符合项目"快速验证方法论"的核心目标
2. **数据格式兼容性问题**: Google无法解析项目的JSON/JSONL知识库文件，且其数据格式规范不明确，严重阻碍知识库构建
3. **模型能力限制**: Vertex AI Agent当前不支持Gemini 2.5 Pro，无法使用最新的模型能力

### 🔄 **决策调整原则**
基于**"保持核心创新，简化技术实现"**的原则，我们决定：
- **保留**: 双Agent对抗博弈的核心方法论（项目的真正价值所在）
- **回归**: 阶段A确定的务实技术路线（Express + LangChain + Gemini直接API）
- **目标**: 聚焦方法论验证，而非技术复杂度展示

---

## 目标

基于用户端对抗优化方法论，在 Dify 平台内构建最小可行的双Agent对抗博弈实验系统，验证基于prompt博弈的对抗优化方法论的技术可行性。核心实验内容：在Dify工作流中实现Generator Agent（诗人陆家明）与Discriminator Agent（批评家）的动态对抗循环，建立结构化输出与引文核验机制，形成可分享、可通过API调用的理论验证原型。

**业务价值**：
- 为陆家花园项目提供可验证的AI诗人服务原型
- 验证现代诗人风格模仿和检测的技术能力
- 建立具有理论贡献价值的AI内容生产系统最小演示

**技术价值**：
- 实证基于prompt博弈的对抗优化方法论的有效性
- 验证Dify平台在复杂AI系统构建中的工程价值
- 建立可复制的小团队AI内容生产解决方案
- 形成可导出/导入的DSL资产和最佳实践

## 范围与约束

- **技术基础**: 基于Dify平台的工作流构建能力，使用Chatflow/Workflow、知识库、LLM节点、条件分支等
- **资源约束**: 单人实验团队，基于Dify云服务或社区版，无需本地代码开发
- **验证范围**: 以最小可行原型验证对抗博弈方法论，重点关注结构化输出与引文核验
- **兼容性约束**: 形成可导出的DSL资产，便于后续本地系统集成

## 任务列表

> **任务编号规范**
> - 阶段2025-08-31_A使用前缀"A"：任务A.1、任务A.2、任务A.3 …；步骤使用"A.1.x"、"A.2.x"的三级编号

---

### **阶段08-31_A：双Agent对抗博弈实验系统构建**

#### - [ ] 任务A.1：知识库架构设计与构建
- **核心思想**: 数据库作为唯一真源（Single Source of Truth），对外一次性导出“干净可读文本（Markdown）+ 元数据”的语料；在Dify内构建风格域与正典域两个独立知识库，为Generator与Discriminator提供差异化检索支持。结构化JSON/JSONL保留为权威数据源与评测集，不直接作为可检索文本入索引。
- **实施内容**:
  - 语料形态（索引用）：采用 Markdown/TXT。风格域仅包含「篇章/题目/引文/引文出处/正文」的人类可读文本；结构字段（如 series、poem_id、主题标签等）作为元数据保存，不并入可检索文本。
  - 分段策略：
    - 风格域（项目语料/吴任几风格）：通用模式，按诗作与自然段切分，保证每段为完整语义单元。
    - 正典域（《周易》《春秋公羊传》《孟子》）：父子模式（父=书目·篇章；子=细粒度断句/小节），统一“书目·篇章”命名，增强命中与归因。
  - 元数据字段建议：
    - 风格域：series、poem_id、title、subseries/主题、tags。
    - 正典域：book、chapter（书目·篇章）、location/canon_id、断句索引。
  - 检索设置：混合检索 + 重排（rerank）。
    - 风格域：top_k=4–6，关键词:向量≈0.3:0.7。
    - 正典域：top_k=6–8，开启重排以提升跨书目检索质量。
  - 多库联检：知识检索节点同时关联风格域与正典域并启用重排；或分别检索后用变量聚合/列表操作合并上下文供同一 LLM 节点使用。
  - 召回与归因验证：使用“召回测试/引用归属”视图验证样本查询的相关性与篇章归因准确性，记录参数与结果。
- 交付物：
  - [ ] **知识库架构方案**: 分域设计、分段模式与元数据字段清单
  - [ ] **风格域语料与导入记录**: Markdown 文本与元数据映射、导入配置
  - [ ] **正典域语料与导入记录**: 三书 Markdown 文本、父子分段与导入配置
  - [ ] **检索与重排配置报告**: top_k、权重、重排开关的对比实验与结论
- 验收标准：
  - [ ] 已在 Dify 中创建并导入“风格域（通用模式）”与“正典域（父子模式）”两个独立知识库，索引语料为 Markdown 文本
  - [ ] 多库检索+重排生效，样本查询召回相关且归因到正确“书目·篇章/句段”
  - [ ] 检索配置能稳定支撑后续 G/D 节点上下文需求
- **风险评估**: 中风险 - 文本清洗质量、分段粒度与权重设置直接影响召回与生成质量
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/corpus/` - 清洗后的 Markdown 正文与元数据映射 Markdown（分文件）
  - `lugarden_universal/lu_the_poet/` - 实验记录与配置文档
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
##### - [ ] 子任务A.1.1：风格域知识库（简体）
- **目标**: 为 G（生成器）提供高质量风格上下文，使用“简体+干净文本”的项目原创诗作，结构字段仅作为元数据，不并入可检索文本。
- **来源与简体策略**:
  - 唯一真源：数据库。导出为 Markdown（标题/引文/出处/正文），必要时使用 OpenCC 统一为大陆简体规范（如：系辞/贤/礼等用字）。
  - 过渡期（如需）：可临时依据 `lugarden_universal/lu_the_poet/corpus/human` 中的人类可读文本生成 MD，随后以数据库导出替换为准。
- **字段映射与导出规范（基于 Prisma 模型 `ZhouPoem`）**:
  - 源表/模型：`ZhouPoem`（生产 schema：`id, title, chapter, body(Json), filePath?, coreTheme?, problemSolved?, spiritualConsolation?, classicalEcho?, poetExplanation?, universeId, subProjectId?`，唯一键：`[universeId, title]`）。
  - 选择条件：限定 `Universe.code = 'zhou'` 或指定的 `universeId`；仅导出发布态数据（如有状态控制则附加过滤）。
  - 文本生成：
    - 标题：取 `title`；章节标识用于元数据（`chapter`）。
    - 正文：从 `body`（JSON）解析为段落/行（支持形态：字符串、行数组、或对象键 `paragraphs/lines`）。
  - 元数据映射（写入 KB 文档 metadata，不进入可检索正文）：
    - `chapter`→chapter；`coreTheme`→core_theme；`problemSolved`→problem_solved；`spiritualConsolation`→spiritual_consolation；`classicalEcho`→classical_echo；`poetExplanation`→poet_explanation；`filePath`→source_path；`universeId`→universe_id；`subProjectId`→sub_project_id。
  - 命名与定位：文档 slug 建议 `zhou/{chapter}/{normalized-title}`；文件命名：正文 `zhou-{chapter}-{normalized-title}.md`，映射 `zhou-{chapter}-{normalized-title}-metadata.md`；保留 `locator`（`chapter + title`）作为 D/RAG 归因锚点。
  - 质量约束：导出前做简体统一、去除控制符/空白行折叠、校验 `title` 非空且 `body` 展开后≥1段。
- **`body`(JSON) 典型结构解析规则**:
  - 支持格式：
    - 字符串：整首诗作为一个文本块；按换行符切分为行/段。
    - 数组（`string[]`）：每个元素代表一段/一行；空字符串或仅含空白视为段落分隔。
    - 对象：以下键优先级检测（由上至下）：
      - `paragraphs: string[]` → 直接作为段落；
      - `stanzas: string[][]` → 每个小节内的行合并为段；
      - `lines: string[]` → 聚合为段（遇空行分段）；
      - `content: string | string[] | { ... }` → 递归按以上规则展开；
      - 其他键（如 `format, type`）仅作提示，不进入文本。
  - 标准化流程：
    - 简体统一（OpenCC t2s/tw2sp）；
    - 去除零宽与控制字符；半角/全角与中文引号规范化（“”‘’）；
    - 去重与裁剪：行首尾空白清理；连续空行折叠为单一段落分隔；
    - 严格保留创作上的分行（不合并非空行）。
  - Markdown 生成规范（风格域 KB）：
    - 文档级：`# 标题` 仅用于父文档锚点（不参与可检索正文）；
    - 正文块：按段输出；子级分段文本作为检索单元；
    - 元数据全部写入 KB 的 metadata，不写入正文。
  - 校验规则：
    - 至少 1 段文本，且每段至少 1 非空行；
    - `title` 非空；`chapter` 存在；
    - 展开后总长度与行数在合理阈值内（例如行数 ≤ 200，字符数 ≤ 8k，可按经验调整）。
  - 失败与回退：
    - 解析失败 → 记录 `id` 与 `filePath`，跳过导入并输出错误清单；
    - 结构未知但可降级为字符串 → 连接所有叶子文本，以换行分隔。
  - 示例：
    - 字符串：
      ```json
      "我们情况差不多\n……\n（段落二）"
      ```
    - 数组：
      ```json
      ["（段一）第一行", "第二行", "", "（段二）第一行"]
      ```
    - 对象：
      ```json
      {"paragraphs": ["段一……", "段二……"]}
      ```
- **分段与元数据**:
  - 分段：通用模式。父=整首诗（标题为锚），子=自然段/行段，保证语义完整。
  - 元数据字段（与 Prisma 一致）：
    - `poem_id(ZhouPoem.id)`, `title`, `chapter`
    - `core_theme`, `problem_solved`, `spiritual_consolation`, `classical_echo`, `poet_explanation`
    - `source_path`, `universe_id`, `sub_project_id`
    - 可选：`alt_titles`, `tags`, `created_at`, `version`, `source_url`
- **检索设置**: 混合检索 + 重排；top_k=4–6；关键词:向量≈0.3:0.7。
- **交付物**:
  - [ ] 风格域 Markdown 正文（简体）与元数据映射 Markdown（分文件）
  - [ ] 导入配置与记录（检索、重排参数）
- **验收标准**:
  - [ ] 样本查询稳定命中目标诗作与对应段落
  - [ ] 召回上下文与预期风格特征一致，文本为简体且无结构噪声
- **执行步骤**：
  - [ ] 步骤A.1.1.1：从 Prisma 生产库导出 `ZhouPoem` → 生成两份产物：正文 `zhou-{chapter}-{normalized-title}.md` 与映射 `zhou-{chapter}-{normalized-title}-metadata.md`（按上述字段映射；仅上传正文至 Dify，元数据通过知识库元数据功能或 API 写入）
  - [ ] 步骤A.1.1.2：统一命名与通用分段；补全元数据字段
  - [ ] 步骤A.1.1.3：导入 Dify 风格域 KB，配置混合检索+重排
  - [ ] 步骤A.1.1.4：进行召回与归因自测，记录参数与结果

##### - [ ] 子任务A.1.2：正典域知识库（简体，核验专用）
- **目标**: 为 D（判别器）提供“唯一正典库（简体）”，覆盖《周易》《春秋公羊传》《孟子》，用于引文真实性硬核验与引用归属。
- **来源与简体策略**:
  - 主来源：维基文库简体（zh-hans），可合法再利用并支持导出。
    - 周易：`https://zh.wikisource.org/zh-hans/周易`
    - 春秋公羊传：`https://zh.wikisource.org/zh-hans/春秋公羊传`
    - 孟子：`https://zh.wikisource.org/zh-hans/孟子`
  - 繁转简：如个别条目仅有繁体，使用 OpenCC 统一为简体；保留原始来源 URL。
  - 校对与命名：对照 CTP 统一篇章与结构（仅对照，不批量抓取，引用需附链接）：
    - CTP·周易：`https://ctext.org/book-of-changes/zh`
    - CTP·公羊传：`https://ctext.org/gongyang-zhuan/zh`
    - CTP·孟子：`https://ctext.org/mengzi/zh`
- **分段与元数据**:
  - 父子分段：父=“书目·篇章”标题，子=细粒度断句/小节；在子级存放“书目·篇章+原句/断句”锚点，便于 D 的精确核验。
  - 元数据字段：`book, chapter, section, alt_titles_trad, locator, source_url, canon_id`。
- **检索设置**: 混合检索 + 重排；top_k=6–8；优化跨书目检索质量。
- **交付物**:
  - [ ] 三书简体 Markdown（父子分段）与元数据映射
  - [ ] 导入配置与记录（检索、重排参数）
  - [ ] 篇章命名对照表（含繁/简异名）
- **验收标准**:
  - [ ] D 的核验节点仅认可本库命中“书目·篇章+原句/断句”即通过；未命中直接“驳回”
  - [ ] 5–10 条标准化断句检索命中正确篇章与原文，归因准确
- **合规说明**:
  - 维基文库文本属公有领域，可再利用；
  - CTP 页面禁止自动化批量下载，允许引用请附对应页面链接；遵守其使用条款。
- **执行步骤**：
  - [ ] 步骤A.1.2.1：获取三书简体文本（维基文库）；必要时繁转简
  - [ ] 步骤A.1.2.2：统一命名与父子分段，生成 Markdown 与元数据
  - [ ] 步骤A.1.2.3：导入 Dify 正典域 KB，配置混合检索+重排
  - [ ] 步骤A.1.2.4：执行核验样本检索与归因测试，记录结果

#### - [ ] 任务A.2：双Agent工作流架构实现
- **核心思想**: 在Dify工作流中构建Generator Agent与Discriminator Agent的对抗循环，实现创作→评估→迭代的完整闭环，支持最多3轮优化迭代
- **实施内容**:
  - 设计Chatflow/Workflow拓扑：Start → 知识检索 → G → D → If/Else → 迭代/Answer
  - 配置G（生成器）与D（判别器）的LLM节点与提示策略
  - 实现基于条件分支的迭代控制逻辑（≤3轮，末轮兜底）
  - 建立节点间的变量传递与上下文管理
- 交付物：
  - [ ] **工作流拓扑设计**: G/D对抗循环的完整节点图
  - [ ] **LLM节点配置**: G与D的角色定义、提示模板与参数设置
  - [ ] **迭代控制逻辑**: 条件分支与循环次数管理机制
  - [ ] **变量传递方案**: 节点间数据流与上下文管理
- 验收标准：
  - [ ] 成功构建包含G/D/If-Else的完整工作流
  - [ ] 验证最多3轮迭代逻辑与末轮兜底机制
  - [ ] 确认节点间变量传递与上下文注入正常
- **风险评估**: 高风险 - 核心对抗逻辑的复杂性与稳定性
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 工作流配置与实验记录
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.2.1：设计双Agent工作流拓扑结构
  - [ ] 步骤A.2.2：配置Generator Agent的LLM节点与提示
  - [ ] 步骤A.2.3：配置Discriminator Agent的LLM节点与提示
  - [ ] 步骤A.2.4：实现条件分支与迭代控制逻辑

#### - [ ] 任务A.3：结构化输出与路由稳健性
- **核心思想**: 建立Discriminator的结构化输出规范与稳健的路由机制，确保"发表/驳回"决策的可靠解析，避免路由脆弱性问题
- **实施内容**:
  - 设计D的结构化输出模板（行首键名固定）
  - 实现基于精确匹配的If/Else路由逻辑
  - 建立软指标输出（风格保真度、证据充足度）与错误码机制
  - 验证路由在噪声与边界情况下的稳定性
- 交付物：
  - [ ] **结构化输出模板**: D的标准化输出格式与键名规范
  - [ ] **路由配置方案**: If/Else的精确匹配逻辑与容错机制
  - [ ] **软指标设计**: 风格保真度与证据充足度的输出规范
  - [ ] **稳定性测试**: 边界情况与噪声输入的路由验证
- 验收标准：
  - [ ] D输出严格遵循行首键名格式，仅第一行包含"发表/驳回"
  - [ ] If/Else路由基于精确匹配，避免关键字误触发
  - [ ] 软指标输出格式统一，支持后续量化分析
- **风险评估**: 中风险 - 路由稳定性直接影响系统可靠性
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 输出规范与测试记录
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.3.1：设计D的结构化输出模板与键名规范
  - [ ] 步骤A.3.2：配置If/Else的精确匹配路由逻辑
  - [ ] 步骤A.3.3：实现软指标输出与错误码机制
  - [ ] 步骤A.3.4：验证路由在边界情况下的稳定性

#### - [ ] 任务A.4：引文核验机制与正典域校验
- **核心思想**: 建立基于"唯一正典语料库"的引文核验机制，实现D对引文真实性的刚性校验，确保"选择自由，验证刚性"的方法论落地
- **实施内容**:
  - 设计引文核验的检索策略（仅在正典域查证）
  - 建立规范化命名与近似匹配规则
  - 实现未命中→不合规→驳回的硬门槛逻辑
  - 验证引文核验的准确性与覆盖度
- 交付物：
  - [ ] **引文核验策略**: 基于正典域的检索与匹配规则
  - [ ] **命名规范标准**: 周易/公羊传/孟子的统一命名格式
  - [ ] **硬门槛逻辑**: 未命中引文的强制驳回机制
  - [ ] **核验准确性验证**: 基于样本的引文校验效果评估
- 验收标准：
  - [ ] D仅在正典域核验"书目·篇章+原句/近似断句"
  - [ ] 未在正典域命中的引文直接判为"不合规"并"驳回"
  - [ ] 规范化命名与近似匹配规则覆盖主要变体
- **风险评估**: 高风险 - 引文核验的准确性直接影响方法论可信度
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 核验规则与测试样本
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.4.1：设计基于正典域的引文核验策略
  - [ ] 步骤A.4.2：建立规范化命名与近似匹配规则
  - [ ] 步骤A.4.3：实现未命中引文的硬门槛驳回逻辑
  - [ ] 步骤A.4.4：验证引文核验的准确性与覆盖度

#### - [ ] 任务A.5：API访问与DSL资产化
- **核心思想**: 建立实验系统的API访问能力与DSL资产导出机制，确保原型可通过程序化方式调用，并可导出为可复用的配置资产
- **实施内容**:
  - 配置应用API访问与认证机制
  - 验证API调用与控制台操作的一致性
  - 实现DSL导出与跨环境导入验证
  - 建立分享链接与外部访问能力（如适用）
- 交付物：
  - [ ] **API访问配置**: 应用API Key生成与调用验证
  - [ ] **一致性测试**: API与控制台行为的对比验证
  - [ ] **DSL资产**: 可导出/导入的工作流配置文件
  - [ ] **跨环境验证**: DSL在不同Dify环境下的可用性测试
- 验收标准：
  - [ ] 成功生成应用API Key并通过REST API触发工作流
  - [ ] API调用结果与控制台操作完全一致
  - [ ] DSL导出成功，跨环境导入后按指引可正常运行
- **风险评估**: 低风险 - 主要是平台功能的标准化使用
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - API测试记录与DSL文件
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.5.1：配置应用API访问与认证
  - [ ] 步骤A.5.2：验证API调用与控制台的一致性
  - [ ] 步骤A.5.3：实现DSL导出与资产化
  - [ ] 步骤A.5.4：验证DSL跨环境导入可用性

#### - [ ] 任务A.6：实验效果评估与方法论验证
- **核心思想**: 建立对抗博弈实验的效果评估体系，通过定量与定性指标验证基于prompt博弈的对抗优化方法论的实际效果
- **实施内容**:
  - 设计实验评估指标（迭代收敛率、质量提升度、稳定性）
  - 实施多轮对抗实验与数据收集
  - 分析Generator与Discriminator的对抗效果
  - 形成方法论验证结论与改进建议
- 交付物：
  - [ ] **评估指标体系**: 定量与定性的方法论效果评估标准
  - [ ] **实验数据集**: 多轮对抗实验的完整记录与分析
  - [ ] **效果分析报告**: Generator/Discriminator对抗效果的深度分析
  - [ ] **方法论验证结论**: 基于实验数据的理论可行性评估
- 验收标准：
  - [ ] 完成至少10轮完整的对抗博弈实验循环
  - [ ] 建立量化的迭代收敛与质量提升评估体系
  - [ ] 形成基于数据的方法论可行性结论
- **风险评估**: 高风险 - 实验效果直接决定方法论价值
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 实验数据与分析报告
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.6.1：设计实验评估指标与数据收集方案
  - [ ] 步骤A.6.2：实施多轮对抗博弈实验
  - [ ] 步骤A.6.3：分析Generator与Discriminator的对抗效果
  - [ ] 步骤A.6.4：形成方法论验证结论与改进建议

---

## 测试与验收
- 每个任务都需要有明确的技术验收标准和质量评估方法
- 需要进行双Agent系统的功能测试和对抗循环验证
- 需要验证方法论有效性的定量和定性评估
- 需要确保DSL资产的可导出性和跨环境可用性
- 重点验证Dify平台构建复杂AI系统的稳定性和可维护性

## 更新日志关联
- **预计更新类型**: 双Agent对抗博弈实验系统开发/方法论验证（基于Dify平台）
- **更新目录**: `documentation/changelog/2025-08-31_陆家明AI诗人双Agent对抗博弈实验完成/`
- **更新日志文件**: `更新日志.md`
- **测试验证点**: 
  - [ ] 双Agent对抗循环功能完整性验证（基于Dify工作流）
  - [ ] 对抗博弈方法论有效性验证（结构化输出与引文核验）
  - [ ] 知识库检索与核验机制性能验证
  - [ ] API访问与DSL资产化验证

## 注意事项
- 本阶段基于Dify平台能力，专注于理论验证而非工程实现
- 重点关注方法论验证而非技术复杂度展示，聚焦核心创新价值
- 基于Dify云服务或社区版进行成本控制，API调用成本透明
- 保持实验记录清晰，每个任务完成后单独记录
- 每个技术实现都要有充分的文档和测试用例
- 确保双Agent系统基于Dify平台的稳定性和可复现性
- 充分利用Dify的工作流、知识库、API等成熟功能，降低技术风险

## 完成后的操作
- [ ] 创建更新目录：`documentation/changelog/2025-08-31_陆家明AI诗人双Agent对抗博弈实验完成/`
- [ ] 将本TODO文件移动到更新目录并重命名为 `TODO.md`
- [ ] 创建对应的更新日志文档：`更新日志.md`
- [ ] 提交所有更改到Git
- [ ] 准备下一阶段的本地系统集成工作

## 当前状态
🔄 进行中 - 基于Dify平台的双Agent对抗博弈实验系统构建，专注方法论理论验证，共6个核心任务

---
*本TODO基于陆家花园项目Git开发指南格式创建，专注于基于Dify平台的双Agent对抗博弈实验验证*