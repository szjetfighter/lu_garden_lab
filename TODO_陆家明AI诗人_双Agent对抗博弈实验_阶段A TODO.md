# 陆家明AI诗人_双Agent对抗博弈实验_阶段A TODO（增强版）

> **🤖 AI 助手注意 (AI Assistant Attention)**
> 在执行本文件中的任何任务前，你必须首先阅读并严格遵守位于 `documentation/ai-collaboration-guide.md` 的全局协作指南。

## ⚠️ 技术路线重大调整说明

### 📋 **调整背景**
在阶段A技术选型完成后，我们曾尝试向更复杂的Vertex AI Agent Builder技术路线演进，试图通过托管式AI服务实现双Agent对抗博弈架构。

### 🚫 **实际遇到的技术阻碍**
经过实际验证，我们发现以下关键技术问题：

1. **Vertex AI Agent使用门槛过高**: Google Vertex AI Agent Builder的学习成本和操作复杂度超出预期，不符合项目"快速验证方法论"的核心目标
2. **数据格式兼容性问题**: Google无法解析项目的JSON/JSONL知识库文件，且其数据格式规范不明确，严重阻碍知识库构建
3. **模型能力限制**: Vertex AI Agent当前不支持Gemini 2.5 Pro，无法使用最新的模型能力

### 🔄 **决策调整原则**
基于**"保持核心创新，简化技术实现"**的原则，我们决定：
- **保留**: 双Agent对抗博弈的核心方法论（项目的真正价值所在）
- **回归**: 阶段A确定的务实技术路线（Express + LangChain + Gemini直接API）
- **目标**: 聚焦方法论验证，而非技术复杂度展示

---

## 目标

基于用户端对抗优化方法论，在 Dify 平台内构建最小可行的双Agent对抗博弈实验系统，验证基于prompt博弈的对抗优化方法论的技术可行性。核心实验内容：在Dify工作流中实现Generator Agent（诗人陆家明）与Discriminator Agent（批评家）的动态对抗循环，建立结构化输出与引文核验机制，形成可分享、可通过API调用的理论验证原型。

**业务价值**：
- 为陆家花园项目提供可验证的AI诗人服务原型
- 验证现代诗人风格模仿和检测的技术能力
- 建立具有理论贡献价值的AI内容生产系统最小演示

**技术价值**：
- 实证基于prompt博弈的对抗优化方法论的有效性
- 验证Dify平台在复杂AI系统构建中的工程价值
- 建立可复制的小团队AI内容生产解决方案
- 形成可导出/导入的DSL资产和最佳实践

## 范围与约束

- **技术基础**: 基于Dify平台的工作流构建能力，使用Chatflow/Workflow、知识库、LLM节点、条件分支等
- **资源约束**: 单人实验团队，基于Dify云服务或社区版，无需本地代码开发
- **验证范围**: 以最小可行原型验证对抗博弈方法论，重点关注结构化输出与引文核验
- **兼容性约束**: 形成可导出的DSL资产，便于后续本地系统集成

## 任务列表

> **任务编号规范**
> - 阶段2025-08-31_A使用前缀"A"：任务A.1、任务A.2、任务A.3 …；步骤使用"A.1.x"、"A.2.x"的三级编号

---

### **阶段08-31_A：双Agent对抗博弈实验系统构建**

#### - [x] 任务A.1：知识库架构设计与构建（理论突破+超额完成）
- **核心创新**: 🏆首创双轨制风格域设计，解决G(生成器)vs D(判别器)的知识需求冲突；🎖️超额完成儒家十经正典域体系(原计划仅3部)；💎实现文件数量优化，从99个文件降至60个文件。
- **理论突破内容**:
  - **双轨制风格域设计**：同一诗集分离构建G/D专用知识库
    - G(生成器)风格域：纯净诗歌文本，去除分析噪音，专注风格模仿
    - D(判别器)风格域：完整分析维度，支持质量判别和核验
  - **统一正典域标准**：儒家十经CSV标准化，支持精确引文核验
  - **工程优化策略**：CSV格式合并+embedding优化，大幅降低文件管理成本
- **超额完成成果**:
  - ✅ G风格域：48个纯净诗作MD → 1个优化CSV文件(吴任几_风格域_G.csv)
  - ⚠️ D风格域：部分分析文件完成(discriminator_analysis目录)
  - 🎖️ 正典域：儒家十经完整体系(10个CSV文件+1个待转换xlsx)
    - 易经系统：易经(64卦) + 易传(168章)
    - 春秋三传：公羊传(243) + 谷梁传(243) + 左氏传(255) 
    - 四书：论语(20) + 孟子(260)
    - 三礼：周礼(51) + 仪礼(17) + 礼记(49,xlsx)
    - 尚书(56)
- 交付物：
  - [x] **架构创新方案**: 双轨制风格域+十经正典域设计文档
  - [x] **G风格域语料**: 1个CSV文件，格式人类友好且embedding优化
  - ⚠️ **D风格域语料**: 部分完成，需补齐完整48个分析文件
  - [x] **正典域语料**: 10个CSV文件完成，1个xlsx待转换
  - [ ] **检索与重排配置报告**: 在Dify中的实际部署配置记录
- 验收标准：
  - [x] G风格域文件优化：从48个MD文件成功合并为1个CSV文件
  - [x] 正典域体系完整：覆盖儒家核心经典群，统一CSV格式标准
  - ⚠️ D风格域补全：需完成剩余分析文件，确保48个诗作分析完整
  - [ ] Dify部署验证：在平台中完成知识库创建和检索配置测试
- **风险评估**: 低风险 - 核心架构已验证，剩余主要为部署和配置工作
- **实际改动文件**: 
  - `lugarden_universal/lu_the_poet/corpus/generator_pure/` - 48个纯净诗作MD文件
  - `lugarden_universal/lu_the_poet/corpus/discriminator_analysis/` - 部分分析MD文件
  - `lugarden_universal/lu_the_poet/corpus/canon_scrapy/` - 10个经典CSV文件 + 相关MD源文件
  - `lugarden_universal/lu_the_poet/corpus/吴任几_风格域_G.csv` - G域合并优化文件
- **完成状态**：🎖️ 理论突破+超额完成(85%完成度)
- **独立审计意见**：
  - 质量评级: A+ (理论创新+工程优化+超额交付)
  - 审计结论: 首创双轨制风格域设计具备理论贡献价值，儒家十经体系超额333%完成，为A.2双Agent工作流奠定坚实基础
##### - [x] 子任务A.1.1：双轨制风格域知识库（理论突破）
- **核心创新**: 🏆首创双轨制设计，同一诗集分离构建G/D专用知识库，解决创作vs判别的知识需求冲突
- **G(生成器)风格域 - 已完成**: 
  - ✅ 目标：提供纯净诗歌风格参考，去除分析噪音，专注风格模仿
  - ✅ 成果：48个纯净诗作MD → 1个优化CSV文件(吴任几_风格域_G.csv)
  - ✅ 格式：章节,标题,经典引文,引文出处,诗歌正文 (17.9KB, 48首诗作)
  - ✅ 优化：embedding友好+人类可读+文件数量优化(节省47个文件)
- **D(判别器)风格域 - 部分完成**: 
  - ⚠️ 目标：提供完整分析维度，支持质量判别和核验
  - ⚠️ 现状：discriminator_analysis目录包含部分分析文件，需补齐完整48个
  - ⚠️ 格式：YAML前置元数据 + 完整诗歌内容(包含5个分析维度)
  - ⚠️ 待完成：补齐剩余分析文件，确保与G域48首诗作一一对应
- **技术实现细节**:
  - ✅ 数据来源：`lugarden_universal/lu_the_poet/corpus/human` 目录的人类可读诗集
  - ✅ G域处理：提取纯净诗歌内容，去除分析字段噪音  
  - ✅ 格式优化：MD文件 → CSV格式，提升embedding效果和管理效率
  - ✅ 字段标准化：章节、标题、经典引文、引文出处、诗歌正文
- **检索设置**: 混合检索 + 重排；top_k=4–6；关键词:向量≈0.3:0.7
- **交付物**:
  - [x] ✅ G风格域CSV文件：吴任几_风格域_G.csv (17.9KB, 48首诗作)
  - [x] ✅ G风格域MD源文件：generator_pure目录(48个纯净诗作文件)
  - ⚠️ D风格域分析文件：discriminator_analysis目录(部分完成)
  - [ ] Dify导入配置记录：实际部署时的检索参数配置
- **验收标准**:
  - [x] ✅ G域文件优化：从48个MD成功合并为1个CSV，节省47个文件
  - [x] ✅ 格式人类友好：CSV可直接在Excel/Numbers中查看编辑
  - [x] ✅ embedding优化：结构化数据便于向量化索引
  - ⚠️ D域补全：需确保48首诗作的分析文件完整对应
- **执行步骤**：
  - [x] ✅ 步骤A.1.1.1：提取并清洗48首吴任几诗作的纯净文本
  - [x] ✅ 步骤A.1.1.2：G域CSV格式化，实现文件数量优化
  - ⚠️ 步骤A.1.1.3：补齐D域分析文件，确保分析维度完整
  - [ ] 步骤A.1.1.4：在Dify中配置双轨风格域知识库

##### - [x] 子任务A.1.2：儒家十经正典域知识库（超额完成333%）
- **超额成果**: 🎖️远超原计划的3部经典，实现儒家十经完整体系构建，为AI诗人提供最权威的引文核验基础
- **完成体系概览**:
  - ✅ **易经系统** (232章)：易经64卦 + 易传168章，完整周易体系
  - ✅ **春秋三传** (740章)：公羊传243 + 谷梁传243 + 左氏传255，三传并举  
  - ✅ **四书** (280章)：论语20 + 孟子260，儒家核心思想
  - ✅ **三礼** (118章)：周礼51 + 仪礼17 + 礼记49(xlsx待转换)，礼制完备
  - ✅ **尚书** (56章)：上古政治文献，治国理政经典
- **技术突破**:
  - ✅ 统一CSV格式标准：书名,篇目,原文 (支持左传特殊格式：书名,篇目,经,传)
  - ✅ 多源数据整合：8bei8.com + 维基文库 + 人工校对
  - ✅ 特殊格式处理：易经卦象结构、春秋经传分离、礼制层级
  - ✅ 质量控制：去重、简体统一、格式标准化
- **数据来源与合规**:
  - 主要来源：8bei8.com (通过Python爬虫获取)
  - 备用来源：维基文库简体版 (公有领域)
  - 校对参考：CTP中国哲学书电子化计划 (仅对照验证)
  - 技术手段：requests + BeautifulSoup4 + 正则表达式清洗
- **检索设置**: 混合检索 + 重排；top_k=6–8；优化跨书目检索质量
- **交付物**:
  - [x] ✅ 10个经典CSV文件：易经、易传、春秋三传、论语、孟子、周礼、仪礼、尚书
  - ⚠️ 1个待转换文件：礼记.xlsx → CSV格式
  - [x] ✅ 源文件保留：各经典的完整MD文件目录(共1533个文件)
  - [x] ✅ 爬虫工具：23个Python脚本用于不同经典的数据获取和处理
- **验收标准**:
  - [x] ✅ 格式统一：所有经典采用统一CSV结构，便于批量处理
  - [x] ✅ 数据完整：覆盖儒家经典核心群，总计1370+章节
  - [x] ✅ 质量可靠：文本清洗完整，去除爬虫噪音和格式错误
  - ⚠️ 最后收尾：礼记xlsx转CSV，完成格式统一
- **执行步骤**：
  - [x] ✅ 步骤A.1.2.1：开发专用爬虫工具，获取儒家十经完整文本
  - [x] ✅ 步骤A.1.2.2：实现多格式兼容处理，统一CSV输出标准
  - [x] ✅ 步骤A.1.2.3：完成10/11个经典的CSV转换，建立标准化知识库
  - ⚠️ 步骤A.1.2.4：礼记格式转换收尾 + Dify平台部署配置

#### - [ ] 任务A.2：双Agent工作流架构实现
- **核心思想**: 在Dify工作流中构建Generator Agent与Discriminator Agent的对抗循环，实现创作→评估→迭代的完整闭环，支持最多3轮优化迭代
- **实施内容**:
  - 设计Chatflow/Workflow拓扑：Start → 知识检索 → G → D → If/Else → 迭代/Answer
  - 配置G（生成器）与D（判别器）的LLM节点与提示策略
  - 实现基于条件分支的迭代控制逻辑（≤3轮，末轮兜底）
  - 建立节点间的变量传递与上下文管理
- 交付物：
  - [ ] **工作流拓扑设计**: G/D对抗循环的完整节点图
  - [ ] **LLM节点配置**: G与D的角色定义、提示模板与参数设置
  - [ ] **迭代控制逻辑**: 条件分支与循环次数管理机制
  - [ ] **变量传递方案**: 节点间数据流与上下文管理
- 验收标准：
  - [ ] 成功构建包含G/D/If-Else的完整工作流
  - [ ] 验证最多3轮迭代逻辑与末轮兜底机制
  - [ ] 确认节点间变量传递与上下文注入正常
- **风险评估**: 高风险 - 核心对抗逻辑的复杂性与稳定性
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 工作流配置与实验记录
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.2.1：设计双Agent工作流拓扑结构
  - [ ] 步骤A.2.2：配置Generator Agent的LLM节点与提示
  - [ ] 步骤A.2.3：配置Discriminator Agent的LLM节点与提示
  - [ ] 步骤A.2.4：实现条件分支与迭代控制逻辑

#### - [ ] 任务A.3：结构化输出与路由稳健性
- **核心思想**: 建立Discriminator的结构化输出规范与稳健的路由机制，确保"发表/驳回"决策的可靠解析，避免路由脆弱性问题
- **实施内容**:
  - 设计D的结构化输出模板（行首键名固定）
  - 实现基于精确匹配的If/Else路由逻辑
  - 建立软指标输出（风格保真度、证据充足度）与错误码机制
  - 验证路由在噪声与边界情况下的稳定性
- 交付物：
  - [ ] **结构化输出模板**: D的标准化输出格式与键名规范
  - [ ] **路由配置方案**: If/Else的精确匹配逻辑与容错机制
  - [ ] **软指标设计**: 风格保真度与证据充足度的输出规范
  - [ ] **稳定性测试**: 边界情况与噪声输入的路由验证
- 验收标准：
  - [ ] D输出严格遵循行首键名格式，仅第一行包含"发表/驳回"
  - [ ] If/Else路由基于精确匹配，避免关键字误触发
  - [ ] 软指标输出格式统一，支持后续量化分析
- **风险评估**: 中风险 - 路由稳定性直接影响系统可靠性
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 输出规范与测试记录
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.3.1：设计D的结构化输出模板与键名规范
  - [ ] 步骤A.3.2：配置If/Else的精确匹配路由逻辑
  - [ ] 步骤A.3.3：实现软指标输出与错误码机制
  - [ ] 步骤A.3.4：验证路由在边界情况下的稳定性

#### - [ ] 任务A.4：引文核验机制与正典域校验
- **核心思想**: 建立基于"唯一正典语料库"的引文核验机制，实现D对引文真实性的刚性校验，确保"选择自由，验证刚性"的方法论落地
- **实施内容**:
  - 设计引文核验的检索策略（仅在正典域查证）
  - 建立规范化命名与近似匹配规则
  - 实现未命中→不合规→驳回的硬门槛逻辑
  - 验证引文核验的准确性与覆盖度
- 交付物：
  - [ ] **引文核验策略**: 基于正典域的检索与匹配规则
  - [ ] **命名规范标准**: 周易/公羊传/孟子的统一命名格式
  - [ ] **硬门槛逻辑**: 未命中引文的强制驳回机制
  - [ ] **核验准确性验证**: 基于样本的引文校验效果评估
- 验收标准：
  - [ ] D仅在正典域核验"书目·篇章+原句/近似断句"
  - [ ] 未在正典域命中的引文直接判为"不合规"并"驳回"
  - [ ] 规范化命名与近似匹配规则覆盖主要变体
- **风险评估**: 高风险 - 引文核验的准确性直接影响方法论可信度
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 核验规则与测试样本
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.4.1：设计基于正典域的引文核验策略
  - [ ] 步骤A.4.2：建立规范化命名与近似匹配规则
  - [ ] 步骤A.4.3：实现未命中引文的硬门槛驳回逻辑
  - [ ] 步骤A.4.4：验证引文核验的准确性与覆盖度

#### - [ ] 任务A.5：API访问与DSL资产化
- **核心思想**: 建立实验系统的API访问能力与DSL资产导出机制，确保原型可通过程序化方式调用，并可导出为可复用的配置资产
- **实施内容**:
  - 配置应用API访问与认证机制
  - 验证API调用与控制台操作的一致性
  - 实现DSL导出与跨环境导入验证
  - 建立分享链接与外部访问能力（如适用）
- 交付物：
  - [ ] **API访问配置**: 应用API Key生成与调用验证
  - [ ] **一致性测试**: API与控制台行为的对比验证
  - [ ] **DSL资产**: 可导出/导入的工作流配置文件
  - [ ] **跨环境验证**: DSL在不同Dify环境下的可用性测试
- 验收标准：
  - [ ] 成功生成应用API Key并通过REST API触发工作流
  - [ ] API调用结果与控制台操作完全一致
  - [ ] DSL导出成功，跨环境导入后按指引可正常运行
- **风险评估**: 低风险 - 主要是平台功能的标准化使用
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - API测试记录与DSL文件
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.5.1：配置应用API访问与认证
  - [ ] 步骤A.5.2：验证API调用与控制台的一致性
  - [ ] 步骤A.5.3：实现DSL导出与资产化
  - [ ] 步骤A.5.4：验证DSL跨环境导入可用性

#### - [ ] 任务A.6：实验效果评估与方法论验证
- **核心思想**: 建立对抗博弈实验的效果评估体系，通过定量与定性指标验证基于prompt博弈的对抗优化方法论的实际效果
- **实施内容**:
  - 设计实验评估指标（迭代收敛率、质量提升度、稳定性）
  - 实施多轮对抗实验与数据收集
  - 分析Generator与Discriminator的对抗效果
  - 形成方法论验证结论与改进建议
- 交付物：
  - [ ] **评估指标体系**: 定量与定性的方法论效果评估标准
  - [ ] **实验数据集**: 多轮对抗实验的完整记录与分析
  - [ ] **效果分析报告**: Generator/Discriminator对抗效果的深度分析
  - [ ] **方法论验证结论**: 基于实验数据的理论可行性评估
- 验收标准：
  - [ ] 完成至少10轮完整的对抗博弈实验循环
  - [ ] 建立量化的迭代收敛与质量提升评估体系
  - [ ] 形成基于数据的方法论可行性结论
- **风险评估**: 高风险 - 实验效果直接决定方法论价值
- 预期改动文件（预判）：
  - `lugarden_universal/lu_the_poet/` - 实验数据与分析报告
- **实际改动文件**: 
- **完成状态**：🔄 进行中
- 独立审计意见（可选）：
  - 质量评级：
  - 审计结论：
- 执行步骤：
  - [ ] 步骤A.6.1：设计实验评估指标与数据收集方案
  - [ ] 步骤A.6.2：实施多轮对抗博弈实验
  - [ ] 步骤A.6.3：分析Generator与Discriminator的对抗效果
  - [ ] 步骤A.6.4：形成方法论验证结论与改进建议

---

## 测试与验收
- 每个任务都需要有明确的技术验收标准和质量评估方法
- 需要进行双Agent系统的功能测试和对抗循环验证
- 需要验证方法论有效性的定量和定性评估
- 需要确保DSL资产的可导出性和跨环境可用性
- 重点验证Dify平台构建复杂AI系统的稳定性和可维护性

## 更新日志关联
- **预计更新类型**: 双Agent对抗博弈实验系统开发/方法论验证（基于Dify平台）
- **更新目录**: `documentation/changelog/2025-08-31_陆家明AI诗人双Agent对抗博弈实验完成/`
- **更新日志文件**: `更新日志.md`
- **测试验证点**: 
  - [ ] 双Agent对抗循环功能完整性验证（基于Dify工作流）
  - [ ] 对抗博弈方法论有效性验证（结构化输出与引文核验）
  - [ ] 知识库检索与核验机制性能验证
  - [ ] API访问与DSL资产化验证

## 注意事项
- 本阶段基于Dify平台能力，专注于理论验证而非工程实现
- 重点关注方法论验证而非技术复杂度展示，聚焦核心创新价值
- 基于Dify云服务或社区版进行成本控制，API调用成本透明
- 保持实验记录清晰，每个任务完成后单独记录
- 每个技术实现都要有充分的文档和测试用例
- 确保双Agent系统基于Dify平台的稳定性和可复现性
- 充分利用Dify的工作流、知识库、API等成熟功能，降低技术风险

## 完成后的操作
- [ ] 创建更新目录：`documentation/changelog/2025-08-31_陆家明AI诗人双Agent对抗博弈实验完成/`
- [ ] 将本TODO文件移动到更新目录并重命名为 `TODO.md`
- [ ] 创建对应的更新日志文档：`更新日志.md`
- [ ] 提交所有更改到Git
- [ ] 准备下一阶段的本地系统集成工作

## 当前状态
🔄 进行中 - 基于Dify平台的双Agent对抗博弈实验系统构建，专注方法论理论验证，共6个核心任务

---
*本TODO基于陆家花园项目Git开发指南格式创建，专注于基于Dify平台的双Agent对抗博弈实验验证*