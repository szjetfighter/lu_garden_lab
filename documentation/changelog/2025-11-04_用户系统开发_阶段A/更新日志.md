# 更新日志 - 用户系统开发_阶段A：数据库设计与迁移

> **阶段目标**：创建独立的auth.db，建立User和UserGongBiWork两张表  
> **完成时间**：2025-11-04  
> **实际耗时**：30分钟（预计45分钟）

---

## 📋 概述

### 核心成果

完成用户系统数据库基础架构，采用**数据库分离策略**：
- **lugarden.db**：静态内容数据库（诗歌、主题、映射等）- Git跟踪
- **auth.db**：用户数据库（用户认证、共笔作品）- Git跟踪空库

### 关键决策

**采用数据库分离方案** - 详见路线图3.3节

**理由**：
1. ✅ **运维隔离**：auth.db故障不影响诗歌展示
2. ✅ **Git管理清晰**：用户密码hash最终不入Git
3. ✅ **开源友好**：lugarden.db开箱即用
4. ✅ **备份分离**：静态内容(Git) vs 用户数据(定时备份)

**外键处理**：
- SQLite不支持跨数据库外键
- 解决方案：应用层校验 + 冗余关键字段（历史快照价值）

---

## ✅ 完成任务

### 任务A.1：创建auth-schema.prisma并设计表结构

**交付物**：
- ✅ `prisma/auth-schema.prisma` - 用户数据库schema定义

**表结构设计**：

**User表**（用户凭证）：
```prisma
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String   // bcrypt hash
  createdAt DateTime @default(now())
  
  gongBiWorks UserGongBiWork[]
}
```

**UserGongBiWork表**（用户共笔作品）：
```prisma
model UserGongBiWork {
  // 基本信息
  id          String   @id @default(uuid())
  userId      String
  
  // 外部引用（无外键，仅存ID）
  sourcePoemId String   // 关联lugarden.db的ZhouPoem.id
  mappingId    String   // 关联lugarden.db的ZhouMapping.id
  
  // 冗余字段（来自ZhouPoem）
  sourcePoemTitle String
  sourcePoemChapter String
  
  // 冗余字段（来自ZhouMapping）
  mappingChapter String
  mappingCombination String
  mappingMeaning String?
  
  // 用户输入
  userInput   String
  
  // 陆家明生成的作品
  poemTitle   String
  poemContent String
  poemQuote   String?
  poemQuoteSource String?
  
  // Dify追溯
  conversationId  String
  messageId       String
  usageMetadata   String  // JSON格式
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@index([conversationId])
}
```

**设计亮点**：
1. **完整记录共笔链路**：原诗→用户输入→AI生成作品
2. **冗余关键字段**：用于独立展示，无需JOIN lugarden.db
3. **历史快照价值**：即使原诗被修改/删除，用户作品记录保持不变
4. **完整Dify metadata**：支持未来成本分析、性能优化

### 任务A.2：执行数据库迁移并生成Prisma Client

**交付物**：
- ✅ Prisma迁移文件：`prisma/migrations/20251104021652_init_auth_db/`
- ✅ 新建auth.db数据库：`data/auth.db`
- ✅ Prisma Client：`generated/auth-prisma/`

**执行命令**：
```bash
npx prisma migrate dev --name init_auth_db --schema prisma/auth-schema.prisma
```

**验证结果**：
```
✅ 数据库表:
  - User
  - UserGongBiWork
  - _prisma_migrations

📊 初始数据:
  User表记录数: 0
  UserGongBiWork表记录数: 0
```

---

## 🔧 技术架构变更

### 文件结构

**新增文件**：
```
prisma/
├── schema.prisma          # lugarden.db的schema（已存在）
└── auth-schema.prisma     # auth.db的schema（新增）

data/
├── lugarden.db            # 内容数据库（已存在）
└── auth.db                # 用户数据库（新增）

generated/
├── prisma/                # lugarden.db的Prisma Client（已存在）
└── auth-prisma/           # auth.db的Prisma Client（新增）

migrations/
└── 20251104021652_init_auth_db/   # auth.db初始迁移（新增）
    └── migration.sql
```

### Git跟踪策略

**决策**：初始化阶段将空的auth.db纳入Git跟踪

**理由**：
1. ✅ 开发友好：clone后无需手动运行迁移
2. ✅ 状态干净：当前auth.db只有表结构，无用户数据
3. ✅ 快速启动：新开发环境可直接启动

**风险控制措施**：
- ⚠️ VPS首次部署后，立即执行：`git update-index --skip-worktree data/auth.db`
- ⚠️ 确保VPS的auth.db不会被`git pull`覆盖
- ⚠️ 需在Docker部署指南中新增"auth.db保护"章节

**Git跟踪文件清单**：
```
✅ prisma/auth-schema.prisma        # schema定义
✅ prisma/migrations/20251104...    # 迁移文件
✅ data/auth.db                     # 空数据库（仅表结构）
❌ generated/auth-prisma/           # 已在.gitignore中排除
```

---

## 📊 数据模型详解

### 冗余字段设计理由

**为什么要冗余存储？**

1. **跨数据库限制**：
   - SQLite不支持跨数据库外键
   - auth.db无法JOIN lugarden.db

2. **独立展示需求**：
   - "我的作品"页面需要展示：原诗标题、章节、用户原型
   - 如果不冗余，需要每次查询lugarden.db，增加复杂度

3. **历史快照价值**：
   - 用户作品应保留创作时的原诗状态
   - 即使原诗后来被修改/删除，用户作品记录不变

4. **存储成本极低**：
   - 每条作品多存100字节
   - 10万条 = 10MB
   - 相比运维价值，成本可忽略

### Dify Metadata完整保存

**usageMetadata字段内容示例**：
```json
{
  "prompt_tokens": 1691,
  "prompt_unit_price": "1.25",
  "prompt_price_unit": "0.000001",
  "prompt_price": "0.0015219",
  "completion_tokens": 3447,
  "completion_unit_price": "10",
  "completion_price_unit": "0.000001",
  "completion_price": "0.030345",
  "total_tokens": 5138,
  "total_price": "0.0318669",
  "currency": "USD",
  "latency": 30.482436504000134
}
```

**为什么完整保存？**
- 存储成本极低：100万行约1.2GB
- API调用成本高：100万次约$32,000（￥23万）
- 完整metadata是未来成本分析、性能优化、用户行为分析的基础数据
- 原则：Dify提供的能力，不在数据库设计阶段舍弃

---

## 🎯 技术亮点

1. **数据库分离架构**
   - 静态内容与用户数据物理隔离
   - 故障影响面最小化
   - 备份策略清晰分离

2. **冗余字段设计**
   - 应用层校验替代外键约束
   - 历史快照保留完整性
   - 独立展示无需跨库查询

3. **完整数据追溯**
   - conversationId、messageId确保数据可追溯
   - 完整usageMetadata支持成本分析
   - 为未来数据驱动优化奠定基础

4. **Git跟踪策略平衡**
   - 开发便利性 vs 生产数据安全
   - 空库跟踪 + VPS保护机制
   - 文档化风险控制措施

---

## 📝 开发经验

### 架构决策过程

**初始设计问题**：
- 曾考虑User和UserGongBiWork放在lugarden.db
- 复盘发现4个致命问题（详见路线图3.3节）
- 在实施前通过架构复盘避免了返工

**经验教训**：
1. 单人运维场景，运维简单性优先于技术纯洁性
2. 数据库分离的价值远大于外键约束的价值
3. 充分的前期架构复盘能避免后期重构

### 时间预估

- 预计时间：45分钟
- 实际时间：30分钟
- 提前完成原因：
  - schema设计已在路线图中明确
  - Prisma迁移流程熟悉
  - 无意外问题

---

## 🚀 下一步计划

### 阶段B：后端API实现（预计2小时）

**核心任务**：
1. 密码加密工具（bcrypt）
2. JWT工具（生成、验证）
3. 认证中间件（requireAuth）
4. 用户注册API
5. 用户登录API
6. 保存共笔API
7. 查询我的作品API
8. 删除账户API

**技术栈**：
- bcrypt：密码加密
- jsonwebtoken：JWT生成与验证
- Express middleware：认证拦截

---

## 📚 参考文档

- `TODO_用户系统开发路线图.md` - 战略层规划
- `prisma/auth-schema.prisma` - Schema定义
- `prisma/migrations/20251104021652_init_auth_db/migration.sql` - 迁移SQL

---

**更新时间**：2025-11-04  
**文档版本**：1.0  
**阶段状态**：✅ 已完成

