# VPS部署auth数据库初始化 - 更新日志

**更新日期**: 2025-11-05  
**更新类型**: 基础设施部署  
**影响范围**: VPS生产环境、Dockerfile、数据库管理

---

## 📋 更新概述

本次更新完成了auth.db（用户认证数据库）在VPS生产环境的初始化部署，解决了用户系统从本地开发环境迁移到生产环境的关键问题。

**核心挑战**：
- VPS只更新到10月31日，缺少11月4-5日开发的完整用户系统
- auth.db是新数据库，VPS上完全不存在
- 原Dockerfile只支持单Prisma客户端，需要扩展支持双数据库
- 数据库文件的Git管理策略需要调整

---

## ✨ 核心功能

### 1. Dockerfile多Prisma客户端支持

**问题**: 原Dockerfile只生成`schema.prisma`的Prisma客户端，无法访问auth.db

**解决方案**: 更新构建阶段，同时生成两个数据库的客户端

**Before**:
```dockerfile
RUN npx prisma generate
```

**After**:
```dockerfile
# 生成两个数据库的Prisma客户端
RUN npx prisma generate --schema=prisma/schema.prisma
RUN npx prisma generate --schema=prisma/auth-schema.prisma
```

**效果**: 
- 新镜像大小：348MB（+21MB auth-prisma客户端）
- 构建时间：57.5秒
- 两个数据库都能正常访问

---

### 2. auth.db初始化策略

**问题**: VPS上没有auth.db，如何安全初始化？

**解决方案**: 
1. **短期策略**（一次性）：提交空auth.db到git → VPS拉取 → 提供初始schema
2. **长期策略**：停止追踪auth.db → 通过migration管理schema变化

**执行步骤**:
```bash
# 本地：生成空auth.db
npx prisma db push --schema=prisma/auth-schema.prisma --accept-data-loss

# 提交到git（一次性）
git add lugarden_universal/application/data/auth.db
git commit -m "feat: 添加空的auth.db供VPS初始化使用"

# VPS：拉取并使用
git pull  # 获取空auth.db
chmod 666 lugarden_universal/application/data/auth.db  # 修复权限

# 本地：停止追踪（长期）
git rm --cached lugarden_universal/application/data/auth.db
echo "lugarden_universal/application/data/auth.db" >> .gitignore
```

**设计理念**:
- 空db提交只是"冷启动"手段，不是长期策略
- Schema变化通过`prisma migrate`管理，不依赖db文件
- 符合"数据库文件不进版本控制"的最佳实践

---

### 3. 数据库文件权限处理

**问题**: Git拉取的auth.db默认只读，容器内nodejs用户无法写入

**错误日志**:
```
attempt to write a readonly database
SqliteError { extended_code: 8 }
```

**解决方案**:
```bash
chmod 666 lugarden_universal/application/data/auth.db
```

**原理**: 
- Git不保存文件权限（除了可执行位）
- SQLite需要写权限才能创建journal文件和更新数据
- 容器内使用非root用户（nodejs:nodejs，uid 1001）

**预防措施**: 以后auth.db不再通过git管理，此问题不再出现

---

## 🔧 技术实现

### 部署架构

```
本地开发环境
├── auth.db.bak (备份，264KB，有开发数据)
├── auth.db (工作副本，不追踪)
└── git仓库
    ├── auth-schema.prisma ✓ 追踪
    ├── migrations/ ✓ 追踪
    └── auth.db ✗ 不追踪（已gitignore）

VPS生产环境
├── auth.db (生产数据)
├── lugarden.db (业务数据)
└── Docker容器
    ├── generated/prisma/ (lugarden.db客户端)
    └── generated/auth-prisma/ (auth.db客户端)
```

### 关键文件变更

**Dockerfile** (VPS_review/Dockerfile):
```diff
  FROM base AS builder
  COPY package*.json ./
  RUN npm ci
  COPY prisma ./prisma
- RUN npx prisma generate
- RUN mkdir -p /app/generated && cp -r node_modules/.prisma /app/generated/
+ # 生成两个数据库的Prisma客户端
+ RUN npx prisma generate --schema=prisma/schema.prisma
+ RUN npx prisma generate --schema=prisma/auth-schema.prisma

  FROM base AS runner
  WORKDIR /app
  COPY --from=deps --chown=nodejs:nodejs /app/node_modules ./node_modules
- COPY --from=builder --chown=nodejs:nodejs /app/node_modules/.prisma ./node_modules/.prisma
- COPY --from=builder --chown=nodejs:nodejs /app/generated ./generated
+ # 复制两个Prisma客户端
+ COPY --from=builder --chown=nodejs:nodejs /app/generated ./generated
```

**.gitignore**:
```gitignore
# 数据库文件（包含用户数据，不应提交）
lugarden_universal/application/data/auth.db
lugarden_universal/application/data/auth.db-journal
```

---

## 📊 部署流程记录

### 本地操作

1. **备份开发数据** (13:47)
   ```bash
   cp auth.db auth.db.bak  # 264KB
   ```

2. **生成空auth.db** (13:48)
   ```bash
   rm auth.db
   npx prisma db push --schema=prisma/auth-schema.prisma
   # 生成36KB空db，只有schema结构
   ```

3. **提交空db** 
   ```bash
   git add data/auth.db
   git commit -m "feat: 添加空的auth.db供VPS初始化使用"
   ```

4. **提交前端更新**
   ```bash
   git add dist/
   git commit -m "build: 重新构建前端包含用户注册体验优化"
   ```

5. **推送**
   ```bash
   git push  # 17 commits, 373KB
   ```

---

### VPS操作

1. **FTP上传Dockerfile** (13:43)
   - 工具：ACC FTP
   - 目标：`/root/lu_garden_lab/lugarden_universal/application/Dockerfile`
   - 验证：`grep -n "prisma generate" Dockerfile` 看到2行

2. **拉取代码** (14:02 VPS时间06:02)
   ```bash
   git pull
   # 474个对象，500.46KB
   # 102个文件变更
   ```

3. **备份旧镜像**
   ```bash
   docker tag lu_garden_lab-app:latest lu_garden_lab-app:backup-20251105
   # 旧镜像：3656a35c395c (327MB)
   ```

4. **构建新镜像**
   ```bash
   docker-compose build app
   # 耗时：57.5秒
   # schema.prisma: 6.9s
   # auth-schema.prisma: 5.6s (新增)
   # 新镜像：c88d1a50d6a9 (348MB)
   ```

5. **重启服务**
   ```bash
   docker-compose up -d
   # app: Healthy (31.3s)
   ```

6. **修复权限** (14:07，注册失败后)
   ```bash
   chmod 666 lugarden_universal/application/data/auth.db
   docker-compose restart app
   ```

7. **验证功能**
   ```bash
   # 健康检查
   curl http://localhost:3000/api/health
   # {"ok":true,"db":"ready",...}
   
   # 用户名校验API
   curl "http://localhost:3000/api/auth/check-username?username=test"
   # {"available":true,"message":"用户名可用"}
   
   # 浏览器注册
   # 账号：lujiaming ✓
   ```

---

### 本地善后

1. **恢复开发数据** (14:15)
   ```bash
   cp auth.db.bak auth.db
   ```

2. **停止追踪auth.db**
   ```bash
   git rm --cached lugarden_universal/application/data/auth.db
   ```

3. **添加gitignore**
   ```bash
   echo "lugarden_universal/application/data/auth.db" >> .gitignore
   echo "lugarden_universal/application/data/auth.db-journal" >> .gitignore
   ```

4. **提交并推送**
   ```bash
   git commit -m "chore: 停止追踪auth.db，避免覆盖生产数据"
   git push  # Commit 9faf9e8
   ```

---

## 🎯 验证结果

### 生产环境功能测试

| 功能 | 测试方法 | 结果 |
|------|---------|------|
| 健康检查 | `curl /api/health` | ✅ lugarden.db连接正常 |
| 用户名校验API | `curl /api/auth/check-username` | ✅ 返回正确JSON |
| 用户注册 | 浏览器注册"lujiaming" | ✅ 成功 |
| 实时校验UI | 浏览器输入用户名 | ✅ 绿色"用户名可用" |
| 自动登录 | 注册后 | ✅ 自动登录到"我的作品" |
| auth.db写入 | 注册操作 | ✅ 数据成功写入 |

### Docker镜像对比

| 项目 | 旧镜像 | 新镜像 | 变化 |
|------|--------|--------|------|
| Image ID | 3656a35c395c | c88d1a50d6a9 | - |
| 大小 | 327MB | 348MB | +21MB |
| Prisma客户端 | 1个（schema.prisma） | 2个（+auth-schema） | +1 |
| 构建时间 | - | 57.5s | - |
| 备份标签 | - | backup-20251105 | ✓ |

### Git安全性验证

```bash
# 测试：修改auth.db后检查Git状态
echo "test" >> lugarden_universal/application/data/auth.db
git status | grep auth.db
# 结果：无输出，说明Git不再追踪 ✓
```

---

## 🎨 设计亮点

### 1. 冷启动策略
- **问题**: VPS如何获得初始的auth.db？
- **方案**: 一次性提交空db → 立即gitignore → 以后靠migration
- **优势**: 简单、安全、符合最佳实践

### 2. 权限自愈设计
- **问题**: Git拉取的文件权限不可控
- **方案**: 一次性手动修复 → 以后不再通过git管理
- **优势**: 问题只出现一次，后续无此困扰

### 3. 双重备份保护
- **Docker镜像备份**: backup-20251105 (327MB)
- **本地数据备份**: auth.db.bak (264KB)
- **回滚时间**: <5分钟

### 4. GUI运维友好
- 使用ACC FTP上传Dockerfile（而非git管理）
- 使用ACC SSH执行命令（图形化界面）
- 考虑用户不熟悉Linux，命令简洁清晰

---

## 📝 经验教训

### ✅ 做得好的地方

1. **风险管控**
   - 先备份旧镜像再构建新的
   - 保留备份1-2周观察期
   - 分步验证，每步完成立即测试

2. **文档完整**
   - 记录所有操作时间戳
   - 记录所有命令和输出
   - 记录问题原因和解决方案

3. **工具适配**
   - 考虑用户使用GUI工具（ACC）
   - 命令简洁，不依赖复杂脚本
   - 遵循VPS运维流程规范

### ⚠️ 需要改进的地方

1. **权限预判不足**
   - 应该在部署前就预测到git拉取文件的权限问题
   - 可以在Dockerfile中预设权限

2. **命名不一致**
   - 预期镜像名`lugarden-app`
   - 实际镜像名`lu_garden_lab-app`（docker-compose自动命名）
   - 造成初期困惑

3. **文档滞后**
   - Dockerfile变更应该先更新运维文档
   - VPS_review目录结构应该明确记录

### 📚 后续规范建立

1. **数据库文件管理**
   - ✅ 永远不提交.db文件到git
   - ✅ Schema变化通过`prisma migrate dev`生成迁移文件
   - ✅ 生产环境使用`prisma migrate deploy`应用迁移
   - ✅ 迁移文件提交到git，db文件不提交

2. **Dockerfile管理**
   - ✅ 放在`VPS_review/`目录作为本地备份
   - ✅ 需要更新时通过FTP上传
   - ✅ 不纳入git（基础设施配置，变动频率低）
   - ✅ 每次变更前创建`.bak`备份

3. **部署流程规范**
   - ✅ 本地开发 → 测试 → git push
   - ✅ VPS: git pull → docker-compose build → up -d
   - ✅ 验证功能 → 保留备份镜像1-2周
   - ✅ 出问题立即回滚，稳定后清理备份

---

## 🔍 技术细节

### Prisma客户端生成位置

**lugarden.db客户端** (`schema.prisma`):
```
生成到：generated/prisma/
导入为：import { PrismaClient } from '../generated/prisma/index.js'
连接到：file:../data/lugarden.db
```

**auth.db客户端** (`auth-schema.prisma`):
```
生成到：generated/auth-prisma/
导入为：import { PrismaClient as AuthPrisma } from '../generated/auth-prisma/index.js'
连接到：file:../data/auth.db
```

### Docker多阶段构建

1. **base**: 基础镜像（node:20-alpine + dumb-init + nodejs用户）
2. **deps**: 生产依赖（npm ci --only=production）
3. **builder**: 构建阶段（npm ci + 生成两个Prisma客户端）
4. **runner**: 运行阶段（复制deps + generated + 应用代码）

**优势**:
- 最终镜像不包含devDependencies
- 分层缓存，只有代码变化才重新构建
- 安全（使用非root用户nodejs）

### SQLite权限要求

SQLite需要以下权限：
- **数据库文件**: 读写权限（rw）
- **数据库目录**: 写权限（创建journal文件）
- **journal文件**: 读写权限（事务日志）

`chmod 666`给予所有用户读写权限，满足容器内nodejs用户的需求。

---

## 🚀 后续工作建议

### 短期（1-2周内）

1. **监控观察**
   - 观察VPS运行状态
   - 关注用户注册、登录功能
   - 查看auth.db是否有异常

2. **清理备份**
   - 确认稳定后删除Docker镜像备份
   - 本地保留auth.db.bak作为开发数据

3. **文档补充**
   - 更新运维文档记录本次变更
   - 补充Dockerfile变更说明

### 中期（1个月内）

1. **Migration工作流建立**
   - 如果auth.db有schema变化
   - 使用`prisma migrate dev`生成迁移
   - VPS使用`prisma migrate deploy`应用

2. **性能监控**
   - 监控双数据库的性能影响
   - 评估是否需要优化

### 长期

1. **数据备份策略**
   - 建立auth.db的定期备份机制
   - 备份到OSS或其他安全存储

2. **灾难恢复预案**
   - 准备数据恢复流程
   - 测试回滚方案的可行性

---

## 📦 交付清单

### 代码变更
- ✅ Dockerfile更新（支持双Prisma客户端）
- ✅ .gitignore更新（排除数据库文件）
- ✅ auth.db初始化（VPS生产环境）

### 文档交付
- ✅ TODO.md（完整操作记录）
- ✅ 更新日志.md（本文档）
- ✅ 临时文档清理（TODO_auth_db_部署准备.md已删除）

### 基础设施
- ✅ Docker镜像：lu_garden_lab-app:latest (348MB)
- ✅ 备份镜像：lu_garden_lab-app:backup-20251105 (327MB)
- ✅ 生产数据库：auth.db（已有用户"lujiaming"）

### Git记录
- ✅ Commit 48862b7: 提交空auth.db
- ✅ Commit bf3a541: 提交前端dist
- ✅ Commit 9faf9e8: 停止追踪auth.db + gitignore

---

## 📞 支持信息

**问题排查**：
- 查看app日志：`docker logs lugarden-app --tail=50`
- 检查容器状态：`docker-compose ps`
- 测试健康检查：`curl http://localhost:3000/api/health`

**回滚方案**：
```bash
docker-compose down
docker tag lu_garden_lab-app:backup-20251105 lu_garden_lab-app:latest
docker-compose up -d
```

**联系方式**：
- 项目负责人：西尔
- AI协作：Claude (Cursor AI)

---

**部署完成时间**: 2025-11-05 14:20  
**部署状态**: ✅ 成功  
**生产验证**: ✅ 通过  
**总耗时**: 约2小时（包括问题排查和文档编写）

