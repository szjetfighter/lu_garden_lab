# 陆家花园项目架构重构更新日志

**更新时间**: 2025-11-26  
**版本**: 1.0  
**更新类型**: 架构重构  
**关联TODO**: 无（即时修复）

## 更新概述

分离Prisma迁移目录，解决双数据库（lugarden.db + auth.db）共享单一迁移目录的架构问题。消除`prisma migrate deploy`误操作风险，建立清晰的多数据库管理结构。

## 任务执行情况

### 已完成任务
- [x] 创建`prisma/lugarden/`子目录，迁移主宇宙schema和migrations
- [x] 创建`prisma/auth/`子目录，迁移认证数据库schema和migrations
- [x] 更新两个schema.prisma中的路径配置
- [x] 验证两个数据库的迁移状态
- [x] 验证Prisma Client生成

### 技术实现

**目录结构变更**：
```
# 重构前（混合目录）
prisma/
├── schema.prisma           → lugarden.db
├── auth-schema.prisma      → auth.db
└── migrations/             → 混合6个迁移（4+2）

# 重构后（分离目录）
prisma/
├── lugarden/
│   ├── schema.prisma       → lugarden.db
│   └── migrations/         → 4个迁移
└── auth/
    ├── schema.prisma       → auth.db
    └── migrations/         → 2个迁移
```

**路径配置更新**：
- `prisma/lugarden/schema.prisma`：
  - `output = "../../generated/prisma"`
  - `url = "file:../../data/lugarden.db"`
- `prisma/auth/schema.prisma`：
  - `output = "../../generated/auth-prisma"`
  - `url = "file:../../data/auth.db"`

## 功能验证

- [x] lugarden.db migrate status: up to date (4 migrations)
- [x] auth.db migrate status: up to date (2 migrations)
- [x] lugarden Prisma Client generate: 成功
- [x] auth Prisma Client generate: 成功
- [x] 后端代码引用路径: 无需修改（generated路径不变）

## 影响范围

- **功能影响**：无，纯架构整理
- **配置变更**：
  - 新命令路径：`--schema=prisma/lugarden/schema.prisma`
  - 新命令路径：`--schema=prisma/auth/schema.prisma`
- **部署要求**：
  - VPS需要`git pull`获取新目录结构
  - auth数据库迁移命令更新为：`npx prisma migrate deploy --schema=prisma/auth/schema.prisma`

## 解决的问题

### 原风险场景
```bash
# 危险：混合目录下运行migrate deploy会删除lugarden数据
npx prisma migrate deploy --schema=prisma/schema.prisma
# → 会尝试应用init_auth_db迁移 → DROP所有毛小豆表！
```

### 分离后
```bash
# 安全：各自目录只有各自的迁移
npx prisma migrate deploy --schema=prisma/lugarden/schema.prisma  # 只有4个lugarden迁移
npx prisma migrate deploy --schema=prisma/auth/schema.prisma       # 只有2个auth迁移
```

## 部署策略确认

| 数据库 | 数据类型 | Git状态 | VPS部署方式 |
|--------|----------|---------|-------------|
| lugarden.db | 冷数据 | 被跟踪 | `git pull` 直接覆盖 |
| auth.db | 热数据 | 被忽略 | `prisma migrate deploy` |

## 总结

本次重构消除了双数据库架构中的误操作风险，建立了清晰的目录结构。改动对生产环境零影响，仅是代码组织优化。

---
*本更新基于陆家花园项目Git开发指南创建*
