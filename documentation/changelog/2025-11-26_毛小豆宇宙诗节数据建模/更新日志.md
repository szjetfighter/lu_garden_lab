# 毛小豆宇宙诗节数据建模 - 更新日志

> **更新日期**: 2025-11-26
> **更新类型**: 数据架构扩展
> **状态**: ✅ 已完成

## 更新概述

为毛小豆宇宙数据库新增诗节（Stanza）粒度的数据建模，实现诗歌文本的细粒度拆分，并建立 Stanza 与 Scene 的多对多关联关系。

## 核心变更

### 1. 数据库新增表

| 表名 | 记录数 | 说明 |
|------|--------|------|
| `MaoxiaodouStanza` | 110 | 诗节数据（14首诗拆分） |
| `MaoxiaodouStanzaSceneLink` | 110 | 诗节-场景关联桥表 |

### 2. 数据治理成果

- **Stanza 拆分规则**：
  - 正篇（7首）：按中文编号（一、二、三...）拆分
  - 前篇/番外（7首）：按连续空行拆分

- **StanzaSceneLink 推断**：
  - AI 推断 + 人工复核
  - 置信度分布：high 107 / medium 3

### 3. 场景数据修正

新增场景 `gold_medal_winner_skating_training`（滑冰训练），拆分自原 `gold_medal_winner_gym`。

## 文件变更清单

### 新增文件
- `poeject_maoxiaodou_universe/data/stanzas.json` - 诗节数据（定稿）
- `poeject_maoxiaodou_universe/data/stanza_scene_links.json` - 诗节-场景关联（定稿）
- `poeject_maoxiaodou_universe/scripts/import-stanzas.js` - 数据导入脚本
- `poeject_maoxiaodou_universe/scripts/verify-stanzas.js` - 数据验证脚本
- `documentation/database/lugarden_schema_251126-stanza.md` - Schema设计文档（v3.2）
- `lugarden_universal/application/prisma/lugarden/migrations/20251126090328_add_stanza_tables/` - 数据库迁移

### 修改文件
- `lugarden_universal/application/prisma/lugarden/schema.prisma` - 新增 Stanza 相关 model
- `poeject_maoxiaodou_universe/data/scenes.json` - 新增滑冰训练场景

## 技术细节

### Prisma Schema 新增

```prisma
model MaoxiaodouStanza {
  id String @id
  poemId String
  index Int
  content String
  universeId String
  poem MaoxiaodouPoem @relation(...)
  sceneLinks MaoxiaodouStanzaSceneLink[]
  @@unique([poemId, index])
}

model MaoxiaodouStanzaSceneLink {
  id String @id
  stanzaId String
  sceneId String
  confidence String?  // high | medium
  reason String?      // AI推断依据
  universeId String
  @@unique([stanzaId, sceneId])
}
```

### 关联关系

```
MaoxiaodouPoem (1) ←→ (N) MaoxiaodouStanza
MaoxiaodouStanza (N) ←→ (M) MaoxiaodouScene（通过桥表）
```

## 验证结果

| 检查项 | 结果 |
|--------|------|
| 数据完整性 | 110/110 ✅ |
| 外键完整性 | 孤儿记录 0 ✅ |
| Stanza→Scene 查询 | ✅ |
| Scene→Stanza 查询 | ✅ |
| 链式查询 | ✅ |

## 设计决策记录

1. **confidence/reason 字段保留**：作为运维级元数据，供数据治理复核使用
2. **两层约束框架**：Schema.md（设计层）+ Prisma.schema（契约层）
3. **AI+人工协作**：AI 实施变更，人工复核，符合"双人操作"原则

## 后续可扩展

- 为 Stanza 新增诗学分析字段（narrativeFunction, emotionalTone）
- 建立 Stanza 与 Character/Terminology 的直接关联
- 在"摸诗宇宙"功能中使用 Stanza 作为随机单元

---

*本更新由 AI 助手协助完成，遵循陆家花园项目协作规范*
