# 摸诗宇宙 MVP 开发

> **🤖 AI 助手注意**
> 在执行本文件中的任何任务前，必须先阅读 `documentation/ai-collaboration-guide.md`

## 产品定位

**摸诗宇宙**是一个轻盈的、游戏化的诗歌发现入口，与"周与春秋"的严肃哲学体验形成互补。

**核心体验**：用户通过老虎机"摸诗"，随机发现毛小豆宇宙中的诗节（stanza）。

## 设计变更（2025-11-26）

| 原方案               | 新方案                   |
| -------------------- | ------------------------ |
| 抽词 → Dify生成新诗 | 老虎机 → 展示已有stanza |
| 依赖外部AI服务       | 纯本地数据，无外部依赖   |
| 每次生成新内容       | 发现已有110个stanza      |

## POC验证 ✅

- 老虎机POC：`poeject_maoxiaodou_universe/poc/slot-machine-poc.html`
- 可直接在浏览器运行测试
- 验证内容：
  - 10符号体系（4人物 + 5场景类型 + 1Wild）
  - 5×3矩阵 + 243ways连线判定
  - 逐列停止动画
  - 中奖高亮 + stanza展示

---

## 任务列表

### 阶段A：数据架构补全

#### - [ ] 任务A.1：新增 MaoxiaodouSceneCharacterLink 桥表

- **核心思想**: Scene-Character是N:M关系，需要桥表
- 交付物：
  - schema.prisma 新增模型
  - 数据库迁移
- 验收标准：
  - 桥表结构：id, sceneId, characterId, universeId
  - 外键约束正确
  - @@unique([sceneId, characterId])
- 执行步骤：
  - [ ] 步骤A.1.1：设计桥表schema
  - [ ] 步骤A.1.2：执行 prisma migrate dev
  - [ ] 步骤A.1.3：验证表创建成功

#### - [ ] 任务A.2：导入Scene-Character关联数据

- **核心思想**: 从scenes.json的characters数组导入到桥表
- 交付物：
  - 导入脚本 `import-scene-characters.js`
- 验收标准：
  - 30个scene的characters全部导入
  - 数据与scenes.json一致
- 执行步骤：
  - [ ] 步骤A.2.1：创建导入脚本
  - [ ] 步骤A.2.2：执行导入
  - [ ] 步骤A.2.3：验证数据完整性

---

### 阶段B：摸诗后端API

#### - [ ] 任务B.1：创建摸诗API端点

- **核心思想**: 提供符号生成、连线判定、stanza查询的后端支持
- 交付物：
  - `/api/moshi/spin` - 生成矩阵、判定连线、返回stanza
- 验收标准：
  - 按权重生成5x3符号矩阵
  - 正确判定243ways连线
  - 根据中奖符号返回对应stanza
- 执行步骤：
  - [ ] 步骤B.1.1：创建符号配置（人物/场景类型/Wild）
  - [ ] 步骤B.1.2：实现矩阵生成逻辑
  - [ ] 步骤B.1.3：实现连线判定算法
  - [ ] 步骤B.1.4：实现stanza池查询（通过Scene.type和SceneCharacterLink）
  - [ ] 步骤B.1.5：实现交集逻辑（多符号中奖时）

---

### 阶段C：摸诗前端开发

#### - [ ] 任务C.1：创建摸诗Vue模块

- 交付物：
  - `frontend_vue/src/modules/moshi/`
- 执行步骤：
  - [ ] 步骤C.1.1：创建SlotMachine.vue组件（基于POC）
  - [ ] 步骤C.1.2：创建MoshiHome.vue页面
  - [ ] 步骤C.1.3：创建Pinia store
  - [ ] 步骤C.1.4：配置路由

#### - [ ] 任务C.2：Portal入口集成

- 执行步骤：
  - [ ] 步骤C.2.1：数据库新增摸诗宇宙记录
  - [ ] 步骤C.2.2：Portal页面显示摸诗入口

---

### 阶段D：（可选）数据架构清理

#### - [ ] 任务D.1：评估MaoxiaodouMapping表的必要性

- **问题**: Character.name和Mapping表存在冗余
- 执行步骤：
  - [ ] 检查应用代码是否使用Mapping表的character_label映射
  - [ ] 如不使用，考虑清理冗余数据

#### - [ ] 任务D.2：评估孤立表的关联需求

- **问题**: Terminology、Theme、Theory等表只关联Universe，无实体间关系
- 执行步骤：
  - [ ] 分析是否需要Scene-Terminology桥表
  - [ ] 根据业务需求决定是否补全

---

## 老虎机设计规格

### 符号体系（10个）

| 符号 | 类型     | 代表          | 权重（稀有度） |
| ---- | -------- | ------------- | -------------- |
| 🐻   | 人物     | 毛小豆        | 8（稀有）      |
| 👔   | 人物     | 华少          | 8（稀有）      |
| 🎒   | 人物     | 栋先生        | 8（稀有）      |
| 👩   | 人物     | 张秋          | 8（稀有）      |
| 🏢   | 场景类型 | 办公室社交    | 15（常见）     |
| 🎰   | 场景类型 | 兄弟会社交    | 15（常见）     |
| 🚪   | 场景类型 | 封闭空间      | 15（常见）     |
| 🍻   | 场景类型 | 商务/个人社交 | 15（常见）     |
| 🏃   | 场景类型 | 运动环境      | 12（常见）     |
| 🌸   | Wild     | 陆（百搭）    | 5（最稀有）    |

### 连线判定（243 Ways）

- 5列3行矩阵，3×3×3×3×3 = 243种可能组合
- 从第1列开始，向右连续匹配 ≥3列 = 中奖
- Wild可替代任意符号
- 预期中奖率：25-30%

### 中奖→Stanza映射

```
1. 识别所有中奖符号
2. 计算每个符号的stanza池：
   - 场景类型符号 → scene.type匹配 → 关联stanza
   - 人物符号 → SceneCharacterLink → scene → stanza
3. 多符号中奖 → 取stanza池交集
4. 交集为空 → 降级到最高价值符号的池
5. 从最终池随机选1个stanza展示
```

---

## 设计决策记录

### 1. 为什么从Dify生成改为展示stanza？

- 无外部依赖，响应即时
- 内容质量有保证（人工审核过的诗节）
- 利用已有的110个stanza资源
- 降低开发和运维复杂度

### 2. 为什么Scene-Character用桥表而非JSON字段？

- N:M关系，桥表是单一数据源
- 避免双向JSON的数据冗余和一致性风险
- 支持复杂查询和索引

### 3. 为什么StanzaSceneLink用桥表（实际是1:1）？

- 有额外属性（confidence, reason）
- 为未来可能的多对多扩展预留
- 这是设计选择，不是错误

### 4. 数据库关系类型判断

- **1:N（一对多）**：用外键（如Scene.poemId）
- **N:M（多对多）**：用桥表（如SceneCharacterLink）
- **受控冗余**：JSON字段用于"整体读取"的附属信息（如aliases）

---

## 当前状态

🔄 待开始

---

*创建日期：2025-11-26*
*基于摸诗宇宙设计讨论*
