# 部署日志

> **部署时间**: 2025-12-05 13:20
> **部署环境**: VPS (lugarden.space)
> **关联commit**: 7d3bfa2, cb0f835

## 部署内容

微信分享动态Meta功能实现：

### 后端改动
- 新增 `application/src/config/shareConfig.js` - 分享配置（L0/L1/L2层级）
- 修改 `server.js` - 添加爬虫检测中间件，动态注入og:meta

### 前端改动
- 修改 `router/index.ts` - 统一路由meta.title与分享配置保持一致

### Nginx改动（不在git中）
- 新增爬虫检测map（MicroMessenger/Twitterbot等）
- 修改 `location /` - 爬虫请求转发到Node后端处理动态meta

**变更类型**: 后端+前端+Nginx

## 部署步骤

```bash
# 1. 拉取代码
cd ~/lu_garden_lab
git pull

# 2. 重建app容器（后端代码变更）
docker-compose down
docker-compose build --no-cache app
docker-compose up -d

# 3. 前端构建（路由title变更）
cd lugarden_universal/frontend_vue
npm run build
cd ../..

# 4. Nginx配置更新（已通过FTP上传）
docker-compose restart nginx

# 5. 验证
docker-compose ps
curl -H "User-Agent: MicroMessenger" https://lugarden.space/pending
```

## 执行记录

| 步骤 | 命令 | 结果 |
|------|------|------|
| git pull | `git pull` | ⏳ 待执行 |
| rebuild app | `docker-compose build --no-cache app` | ⏳ 待执行 |
| 前端构建 | `npm run build` | ⏳ 待执行 |
| 重启nginx | `docker-compose restart nginx` | ✅ 已执行 |
| 爬虫测试 | `curl -H "User-Agent: MicroMessenger"` | ✅ 已验证 |

## 验证结果

- [x] Nginx配置生效（爬虫请求转发到Node）
- [x] curl测试返回动态og:meta
- [ ] 微信实际分享显示正确标题和描述

## 技术说明

### 分享配置层级

| 层级 | 路由 | 标题 |
|------|------|------|
| L0 | `/` | 陆家花园 |
| L1 | `/zhou` | 周与春秋 - 陆家花园 |
| L1 | `/maoxiaodou` | 毛小豆宇宙 - 陆家花园 |
| L1 | `/pending` | 匿，腻，溺 - 陆家花园 |
| L2 | `/maoxiaodou/moshi` | 摸诗 - 陆家花园 |
| L2 | `/pending/001_newarrival` | NEW ARRIVAL - 陆家花园 |
| L2 | `/pending/002_whoiszd` | 谁是ZD - 陆家花园 |

### Nginx爬虫检测

```nginx
map $http_user_agent $is_crawler {
    default 0;
    ~*MicroMessenger 1;
    ~*Twitterbot 1;
    ~*facebookexternalhit 1;
    ...
}

location / {
    if ($is_crawler) {
        proxy_pass http://app_upstream;
    }
    try_files $uri $uri/ /index.html;
}
```

---
*模板位置: documentation/templates/部署日志_TEMPLATE.md*
