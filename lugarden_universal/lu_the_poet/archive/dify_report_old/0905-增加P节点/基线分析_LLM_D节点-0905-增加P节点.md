# 陆家明AI诗人 - 基线LLM D节点分析（增加P节点版）

## 📝 D节点概览

**D节点（判别器）共2个**:
- **D1**: 评审G1作品，为P1提供结构化评估 ✨ **错误码标准化升级**
- **D2**: 评审G2作品，为P2提供结构化评估（保持原设计）

**核心职责**:
- 基于知识库标准对诗歌作品进行多维度评估
- 输出标准化的JSON格式评估结果
- 为P节点提供结构化的分析依据

---

## 🎯 D1节点 (1756701800237) - G1作品评审器 ✨ **错误码升级**

### 模型设置
```yaml
model:
  completion_params: {}
  mode: chat
  name: gemini-2.5-pro
  provider: langgenius/gemini/google
```

### 提示词配置
**System提示词**:
```
你是AI文学批评家"判官"，专门负责诗歌评审环节。你需要基于检索到的评审标准对诗歌进行严格评估。

评审对象是：{{#1757046836363.output#}}

知识库参考：

{{#1756965762105.output#}}

{{#1756965735142.output#}}

规则格式参考：

{{#1756963597193.output#}}

评估任务：

1. 检查结构完整性（标题格式、首句规则、篇幅控制）

2. 验证引文真实性（引文格式、出处匹配、内容核实）  

3. 评估风格保真度（与系列基线的相似度）

4. 判断证据充足度（知识库支撑程度）

5. 生成错误码（如发现问题）

6. 提供改进建议（针对性指导）

评估标准：

硬门禁检查（必须全部通过）：

- 标题格式：严格遵循系列格式要求

- 系列首句：特殊首句规则 

- 正文篇幅：≤80字（不含标题和引文）

- 引文验证：格式正确、出处匹配、内容真实

软指标评估：

- 风格保真度：0.00-1.00，≥0.40为合格

- 证据充足度：高/中/低

裁决逻辑：

发表条件：所有硬门禁通过 且 风格保真度≥0.40

驳回条件：任一硬门禁失败 或 风格保真度<0.40

错误码系统：

TITLE_FORMAT_INVALID：标题格式错误

CHAPTER_NAME_INVALID：篇章名不在允许范围  

FIRST_LINE_CONFLICT：系列首句互斥失败

LENGTH_EXCEEDS：正文字数超出80字限制

CITATION_FORMAT_INVALID：引文格式错误

CITATION_NOT_FOUND_IN_CANON：引文在正典域未找到

CITATION_SOURCE_MISMATCH：引文出处与系列不匹配

STYLE_FAITHFULNESS_LOW：风格保真度过低

改进建议原则：

1. 具体可操作，明确指出问题所在

2. 避免触发词，不在建议中使用"发表"或"驳回"等路由关键词

3. 建设性指导，重点提升而非纯粹批评

4. 基于检索到的评审标准提供针对性修改方向

直接输出JSON格式评估结果，无需解释过程。
```

**User提示词**:
```
开始执行评审
```

### 结构化输出Schema ✨ **错误码标准化升级**
```json
{
  "type": "object",
  "properties": {
    "最终裁决": {
      "description": "基于所有评估维度的最终裁决",
      "enum": ["发表", "驳回"],
      "type": "string"
    },
    "结构完整性": {
      "description": "标题格式、首句规则、篇幅控制的整体检查结果",
      "enum": ["合规", "不合规"],
      "type": "string"
    },
    "引文验证状态": {
      "description": "引文格式、出处匹配、真实性核验结果",
      "enum": ["通过", "失败", "无引文"],
      "type": "string"
    },
    "风格保真度": {
      "description": "与系列基线的风格相似度评分，取值范围0-1",
      "type": "number",
      "minimum": 0,
      "maximum": 1
    },
    "证据充足度": {
      "description": "知识库支撑和论证逻辑的充分程度",
      "enum": ["高", "中", "低"],
      "type": "string"
    },
    "错误码": {
      "description": "具体的错误类型，无错误时为NO_ERROR",
      "type": "string",
      "enum": [
        "NO_ERROR",
        "TITLE_FORMAT_INVALID",
        "CHAPTER_NAME_INVALID",
        "FIRST_LINE_CONFLICT",
        "LENGTH_EXCEEDS",
        "CITATION_FORMAT_INVALID",
        "CITATION_NOT_FOUND_IN_CANON",
        "CITATION_SOURCE_MISMATCH",
        "STYLE_FAITHFULNESS_LOW"
      ]
    },
    "改进建议": {
      "description": "具体可操作的改进建议，无问题时为空字符串",
      "type": "string"
    }
  },
  "required": [
    "最终裁决",
    "结构完整性", 
    "引文验证状态",
    "风格保真度",
    "证据充足度",
    "错误码",
    "改进建议"
  ],
  "additionalProperties": false
}
```

### 关键升级点 ✨
1. **错误码标准化**: 从通用string升级为标准枚举
2. **NO_ERROR支持**: 明确支持无错误场景
3. **P1兼容性**: 确保P1能可靠解析错误码
4. **GEMINI兼容**: 避免空字符串枚举，提升API兼容性

### 其他配置
- **上下文**: 未启用
- **视觉**: 未启用
- **变量**: 无自定义变量
- **Temperature**: 默认
- **结构化输出**: 启用，严格Schema验证

---

## 🔄 D2节点 (17569676735610) - G2作品评审器

### 模型设置
```yaml
model:
  completion_params: {}
  mode: chat
  name: gemini-2.5-pro
  provider: langgenius/gemini/google
```

### 提示词配置
**System提示词**:
```
你是AI文学批评家"判官"，专门负责诗歌评审环节。你需要基于检索到的评审标准对诗歌进行严格评估。

知识库参考：

{{#1756965762105.output#}}

{{#1756965735142.output#}}

规则格式参考：

{{#1756963597193.output#}}

评估任务：

1. 检查结构完整性（标题格式、首句规则、篇幅控制）

2. 验证引文真实性（引文格式、出处匹配、内容核实）  

3. 评估风格保真度（与系列基线的相似度）

4. 判断证据充足度（知识库支撑程度）

5. 生成错误码（如发现问题）

6. 提供改进建议（针对性指导）

评估标准：

硬门禁检查（必须全部通过）：

- 标题格式：严格遵循系列格式要求

- 系列首句：特殊首句规则 

- 正文篇幅：≤80字（不含标题和引文）

- 引文验证：格式正确、出处匹配、内容真实

软指标评估：

- 风格保真度：0.00-1.00，≥0.40为合格

- 证据充足度：高/中/低

裁决逻辑：

发表条件：所有硬门禁通过 且 风格保真度≥0.40

驳回条件：任一硬门禁失败 或 风格保真度<0.40

错误码系统：

TITLE_FORMAT_INVALID：标题格式错误

CHAPTER_NAME_INVALID：篇章名不在允许范围  

FIRST_LINE_CONFLICT：系列首句互斥失败

LENGTH_EXCEEDS：正文字数超出80字限制

CITATION_FORMAT_INVALID：引文格式错误

CITATION_NOT_FOUND_IN_CANON：引文在正典域未找到

CITATION_SOURCE_MISMATCH：引文出处与系列不匹配

STYLE_FAITHFULNESS_LOW：风格保真度过低

改进建议原则：

1. 具体可操作，明确指出问题所在

2. 避免触发词，不在建议中使用"发表"或"驳回"等路由关键词

3. 建设性指导，重点提升而非纯粹批评

4. 基于检索到的评审标准提供针对性修改方向

直接输出JSON格式评估结果，无需解释过程。
```

**User提示词**:
```
{{#17569669412190.text#}}
```

### 结构化输出Schema
```json
{
  "type": "object", 
  "properties": {
    "最终裁决": {
      "description": "基于所有评估维度的最终裁决",
      "enum": ["发表", "驳回"],
      "type": "string"
    },
    "结构完整性": {
      "description": "标题格式、首句规则、篇幅控制的整体检查结果", 
      "enum": ["合规", "不合规"],
      "type": "string"
    },
    "引文验证状态": {
      "description": "引文格式、出处匹配、真实性核验结果",
      "enum": ["通过", "失败", "无引文"],
      "type": "string"
    },
    "风格保真度": {
      "description": "与系列基线的风格相似度评分，取值范围0-1",
      "type": "number",
      "minimum": 0,
      "maximum": 1
    },
    "证据充足度": {
      "description": "知识库支撑和论证逻辑的充分程度",
      "enum": ["高", "中", "低"],
      "type": "string"
    },
    "错误码": {
      "description": "逗号分隔的错误码列表，无错误时为空字符串",
      "type": "string"
    },
    "改进建议": {
      "description": "具体可操作的改进建议，无问题时为空字符串",
      "type": "string"
    }
  },
  "required": [
    "最终裁决",
    "结构完整性",
    "引文验证状态", 
    "风格保真度",
    "证据充足度",
    "错误码",
    "改进建议"
  ],
  "type": "object"
}
```

### 配置特点
- **传统错误码**: 仍使用string类型（兼容原有设计）
- **评审G2**: 专门评审经过P1指导修改的G2作品
- **输入动态**: 接收G2的修改后作品文本

### 其他配置
- **上下文**: 未启用
- **视觉**: 未启用
- **变量**: 无自定义变量
- **Temperature**: 默认
- **结构化输出**: 启用，严格Schema验证

---

## 🔀 D节点变量引用汇总

### D1节点输入变量
- `{{#1757046836363.output#}}` - G1转换输出（G1的诗歌作品）
- `{{#1756965762105.output#}}` - 正典域转换输出（引文参考）
- `{{#1756965735142.output#}}` - 风格域转换输出（风格参考）
- `{{#1756963597193.output#}}` - 规则转换输出（格式规范）

### D2节点输入变量
- `{{#17569669412190.text#}}` - G2的修改后作品
- `{{#1756965762105.output#}}` - 正典域转换输出（引文参考）
- `{{#1756965735142.output#}}` - 风格域转换输出（风格参考）
- `{{#1756963597193.output#}}` - 规则转换输出（格式规范）

### D节点输出变量（被后续节点使用）
**D1输出**:
- `{{#1756701800237.structured_output.最终裁决#}}` - 路由判断
- `{{#1756701800237.structured_output.*#}}` - P1分析依据

**D2输出**:
- `{{#17569676735610.structured_output.最终裁决#}}` - 路由判断
- `{{#17569676735610.structured_output.*#}}` - P2分析依据

---

## 📊 D节点配置对比

| 节点 | 模型 | Temperature | 功能 | 评审对象 | 错误码类型 | 主要创新 |
|------|------|-------------|------|----------|------------|----------|
| D1 | gemini-2.5-pro | 默认 | G1作品评审 | 初次创作 | ✨ 枚举类型 | 错误码标准化 |
| D2 | gemini-2.5-pro | 默认 | G2作品评审 | 修改后作品 | 字符串类型 | 保持原设计 |

---

## 🚀 D1节点错误码升级分析 ✨

### 升级前后对比

**升级前**:
```json
"错误码": {
  "description": "逗号分隔的错误码列表，无错误时为空字符串",
  "type": "string"
}
```

**升级后**:
```json
"错误码": {
  "description": "具体的错误类型，无错误时为NO_ERROR",
  "type": "string",
  "enum": [
    "NO_ERROR",
    "TITLE_FORMAT_INVALID",
    "CHAPTER_NAME_INVALID", 
    "FIRST_LINE_CONFLICT",
    "LENGTH_EXCEEDS",
    "CITATION_FORMAT_INVALID",
    "CITATION_NOT_FOUND_IN_CANON",
    "CITATION_SOURCE_MISMATCH",
    "STYLE_FAITHFULNESS_LOW"
  ]
}
```

### 升级优势

1. **标准化枚举**: 确保错误码的一致性和可预测性
2. **NO_ERROR明确**: 明确定义无错误场景，避免空字符串
3. **P1兼容性**: 确保P1能够可靠识别和处理各种错误码
4. **API兼容性**: 避免GEMINI API对空字符串枚举的限制
5. **类型安全**: 提供编译时和运行时的类型检查

### 错误码映射表

| 错误码 | 含义 | P1转换策略 |
|--------|------|------------|
| NO_ERROR | 无错误 | 基于改进建议进行微调 |
| TITLE_FORMAT_INVALID | 标题格式错误 | 聚焦格式修正 |
| CHAPTER_NAME_INVALID | 篇章名错误 | 聚焦格式修正 |
| FIRST_LINE_CONFLICT | 首句规则冲突 | 聚焦格式修正 |
| LENGTH_EXCEEDS | 篇幅超限 | 聚焦内容精简 |
| CITATION_FORMAT_INVALID | 引文格式错误 | 聚焦引文处理 |
| CITATION_NOT_FOUND_IN_CANON | 引文不在正典 | 聚焦引文处理 |
| CITATION_SOURCE_MISMATCH | 引文出处不匹配 | 聚焦引文处理 |
| STYLE_FAITHFULNESS_LOW | 风格保真度低 | 聚焦风格调整 |

---

## 🔬 评估标准体系

### 硬门禁检查（必须全部通过）
1. **标题格式**: 严格遵循系列格式要求
2. **系列首句**: 特殊首句规则
3. **正文篇幅**: ≤80字（不含标题和引文）
4. **引文验证**: 格式正确、出处匹配、内容真实

### 软指标评估
1. **风格保真度**: 0.00-1.00，≥0.40为合格
2. **证据充足度**: 高/中/低

### 裁决逻辑
```
发表条件: 所有硬门禁通过 AND 风格保真度≥0.40
驳回条件: 任一硬门禁失败 OR 风格保真度<0.40
```

---

## 📈 与P节点协作机制

### D1→P1工作流
```
G1作品 → D1评估 → 结构化输出 → P1分析 → 结构化指导 → G2修改
```

**关键协作点**:
1. **错误码映射**: D1的枚举错误码直接映射到P1的转换策略
2. **改进建议**: D1的文本建议被P1转换为可执行指导
3. **评分依据**: D1的风格保真度影响P1的修改范围判断

### D2→P2工作流
```
G2作品 → D2评估 → 结构化输出 → P2分析 → 结构化指导 → G3修改
```

**关键协作点**:
1. **二轮评估**: D2评估P1指导后的修改效果
2. **深度分析**: D2为P2提供更精细的问题定位
3. **最终优化**: D2/P2协作确保G3的最终质量

---

## ⚠️ 技术考虑

### Schema一致性
- **D1升级**: 需要确保P1能正确处理新的枚举错误码
- **D2保持**: 保持与原有P2设计的兼容性
- **版本管理**: 需要管理不同节点间的Schema版本

### 错误处理
- **枚举验证**: 确保D1只输出预定义的错误码
- **空值处理**: 正确处理NO_ERROR场景
- **兼容性**: 确保与Dify和GEMINI API的兼容性

### 性能影响
- **处理时间**: 结构化输出可能略微增加处理时间
- **准确性**: 枚举约束提高错误码的准确性
- **维护性**: 标准化的错误码便于系统维护

---

## 🎯 优化建议

### 错误码体系
1. **错误码扩展**: 根据实际使用情况增加新的错误码类型
2. **层级分类**: 考虑建立错误码的层级分类体系
3. **严重程度**: 为错误码增加严重程度标识

### 评估精度
1. **评分细化**: 考虑将风格保真度细化为多个子维度
2. **权重配置**: 为不同评估维度配置权重
3. **阈值优化**: 基于实际效果优化各项阈值设置

### 协作优化
1. **接口标准化**: 进一步标准化D节点与P节点的接口
2. **反馈循环**: 建立P节点对D节点评估质量的反馈机制
3. **监控指标**: 增加D节点评估准确性的监控指标

---
*生成时间: 2025-01-11*
*基于YML版本: 0.4.0 (增加P节点)*
