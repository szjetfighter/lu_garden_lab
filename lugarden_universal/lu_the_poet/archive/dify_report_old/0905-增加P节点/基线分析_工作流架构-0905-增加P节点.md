# 陆家明AI诗人 - 基线工作流架构分析（增加P节点版）

## 📊 工作流概览

**应用信息**:
- **应用名称**: 陆家明的周与春秋练习
- **应用模式**: advanced-chat
- **应用图标**: 🤖
- **Dify版本**: 0.4.0

**依赖插件**:
- langgenius/jina:0.0.8 (重排序)
- langgenius/openai:0.2.5 (OpenAI模型)
- langgenius/gemini:0.5.4 (Gemini模型)

## 🔀 节点连接架构

### 主要执行路径

```
用户输入(开始)
    ↓
[变量赋值] → [意图分析LLM] → [意图转换]
    ↓
[三个知识库并行检索: 风格域、正典域、规则域]
    ↓
[知识检索转换] → [G1诗歌创作] → [CHAT2等待] → [G1转换]
    ↓
[D1评审] → [条件分支1]
    ↓
True分支: [CHAT3俏皮话] → [直接回复]
False分支: [D1转换] → [P1智能指导] → [正典域检索2] → [G2修改] → [D2评审] → [条件分支2]
    ↓
True分支: [CHAT4俏皮话] → [直接回复]
False分支: [D2转换] → [P2智能指导] → [正典域检索3] → [G3最终修改] → [CHAT5俏皮话] → [直接回复]
```

### 辅助对话流程

```
[CHAT语气检索] → [语气转换] → [CHAT1氛围调节] → [过渡回复]
    ↓
[CHAT2等待提示] → [继续主流程]
```

## 🎯 核心设计特征

### 1. **三轮智能迭代机制**
- **第1轮**: G1 → D1 → 发表/驳回判断
- **第2轮**: D1 → P1 → G2 → D2 → 发表/驳回判断
- **第3轮**: D2 → P2 → G3 → 强制输出(兜底机制)

### 2. **动态知识库架构**
- **风格域**: dataset_id = 1Y1WQbwVfkwHf+CfRVdWqWVe2lrJ0yLoyYVIYwucnxA0UN2hn0DQlGJtsdXZIlJT
- **正典域**: dataset_id = dqi7IcK7A9tg+J544VDWf8biflTARzG/LIemG8W5A4CaJn7lJP/SzPKFytz2ON6J
- **规则域**: dataset_id = wtBa5CKBmPk0XFg/W/rzdKe5hmjU4qRluehd99lxPz2AfzsJfOC7Db8U3RMXyuoH
- **语气域**: dataset_id = 1Y1WQbwVfkwHf+CfRVdWqWVe2lrJ0yLoyYVIYwucnxA0UN2hn0DQlGJtsdXZIlJT
- **动态引文检索**: 基于P节点的核心任务动态检索相关引文

### 3. **智能路由机制**
- **结构化输出路由**: 基于JSON Schema的"最终裁决"字段
- **精确匹配条件**: `{{structured_output.最终裁决}} == "发表"`
- **双重条件分支**: 两次发表/驳回判断节点

### 4. **会话变量管理**
- **opening**: 固定开场白
- **chattone**: 动态语气检索查询

## 🚀 P节点创新架构

### P节点工作机制
```
D1评估结果 → P1智能分析 → 结构化修改指导 → G2精准修改
D2评估结果 → P2智能分析 → 结构化修改指导 → G3精准修改
```

### P节点输出结构
```json
{
  "核心任务": "本次修改的核心焦点",
  "硬性约束": ["必须严格遵守的约束条件"],
  "修改指导": "具体的修改指导说明",
  "保护要素": ["原作品中必须保持不变的核心元素"],
  "修改范围": "最小化修改|局部调整|重点修改"
}
```

## ⚠️ 架构复杂度分析

### 节点统计
- **总节点数**: ~45个节点
- **LLM节点**: 12个 (意图分析 + 3G + 2D + 2P + 5CHAT)
- **知识检索节点**: 6个 (原4个 + 新增2个动态检索)
- **模板转换节点**: 8个
- **条件分支节点**: 2个
- **回复节点**: 5个

### 架构优势
1. **智能化升级**: P节点实现评估到修改的智能转换
2. **动态适应**: 根据修改需求动态检索相关知识
3. **结构化控制**: 通过JSON Schema确保修改指导的精确性
4. **模块化设计**: 每个P节点专注特定修改轮次

### 潜在挑战
1. **复杂度增加**: 新增4个节点提升了维护成本
2. **Token消耗**: P节点和动态检索增加API调用
3. **调试难度**: 多层转换增加问题定位复杂度

## 📋 节点详细清单

### LLM节点列表
1. **意图分析节点** (1756961820611)
2. **G1** (1756699910424) 
3. **D1** (1756701800237)
4. **P1** (1757044544111) ✨ **新增**
5. **G2** (17569669412190)
6. **D2** (17569676735610)
7. **P2** (17570479873910) ✨ **新增**
8. **G3** (17570479883380)
9. **CHAT1** (1756970904564)
10. **CHAT2** (17569737246690)
11. **CHAT3** (1756968473773)
12. **CHAT4** (17569687362650)
13. **CHAT5** (17569688353670)

### 知识检索节点列表
1. **风格域知识库检索** (1756699728276)
2. **正典域知识库检索** (1756953941881) 
3. **规则域知识库检索** (1756961775730)
4. **CHAT语气检索** (1756977828986)
5. **正典域知识库检索2** (1757048439474) ✨ **新增**
6. **正典域知识库检索3** (17570486115590) ✨ **新增**

## 🎭 开场白设置

```
你好，我是陆家明，陆家花园的主理人

这里是我练习如何模仿吴任几先生写诗的地方

不管你说什么，我都会尝试用一首诗来回复你

我已经准备好了。你想和我聊点儿什么？
```

## 🔬 关键创新点

### 1. **D→P→G对抗循环**
真正实现了基于结构化反馈的智能对抗优化，P节点作为"智能中介"将评估转换为精准指导。

### 2. **动态知识检索**
- P1触发的正典域检索2：基于P1.核心任务动态检索
- P2触发的正典域检索3：基于P2.核心任务动态检索

### 3. **错误码标准化**
D1节点现在输出标准化错误码枚举，包括：
- NO_ERROR
- TITLE_FORMAT_INVALID
- STYLE_FAITHFULNESS_LOW
- 等8种具体错误类型

### 4. **温度策略优化**
- P1/P2: temperature=0.7（创造性分析）
- G2/G3: temperature=0（确定性修改）

---
*生成时间: 2025-01-11*
*基于YML版本: 0.4.0 (增加P节点)*
