# P节点输出JSON Schema设计方案

> **设计版本**: v1.4 (兼容性修正版)  
> **目标模型**: GEMINI 2.5 Pro  
> **设计日期**: 2025-09-05  
> **适用场景**: 双Agent对抗博弈系统中的提示词智能生成  
> **格式来源**: 标准JSON Schema格式，适配Dify界面直接复制使用  
> **修正内容**: 增加NO_ERROR场景处理示例，适配D节点优化

## 🚀 快速使用指南

**在Dify中配置P节点时，请使用第85-119行的JSON格式内容**，这是可以直接复制到Dify界面的标准JSON Schema格式。

完整配置步骤：
1. 在Dify中创建LLM节点
2. 启用"结构化输出"选项  
3. 复制第85-119行的完整JSON内容到Schema配置框中
4. 配置对应的System和User提示词

## 🎯 设计目标

基于D1节点的评估反馈，为G2节点生成结构化的修改指导，实现从"评估反馈"到"操作指令"的智能转换，真正实现prompt层面的对抗优化。

## 🧠 GEMINI兼容性分析

### **技术基础**
- **目标模型**: `gemini-2.5-pro` (G2节点使用)
- **Temperature**: 0 (确定性输出)
- **JSON处理**: 已验证支持（系统现有D节点7字段JSON成功案例）
- **中文处理**: GEMINI对中文理解优秀，建议使用中文字段名
- **Schema格式**: 基于D节点成功案例，使用Dify简化格式

### **兼容性优化策略**
1. **中文字段名**: 减少翻译歧义，直接对应中文指令
2. **扁平化结构**: 避免深层嵌套，降低解析复杂度
3. **明确枚举**: 为模糊字段提供明确选项
4. **简洁描述**: 每个字段都有清晰的操作指向性
5. **Dify格式**: 使用与D节点一致的简化Schema格式

### **⚠️ 格式说明**
本文档的Schema格式严格基于YML文件（`陆家明的周与春秋练习.yml` 第1362-1411行）中D节点的实际配置格式，确保与现有系统完全兼容。注意字段定义顺序（description在前，type在后）和缩进格式必须与YML中保持一致。

## 📋 完整JSON Schema定义

### **Schema结构（基于YML实际格式）**
```yaml
structured_output:
  schema:
    properties:
      核心任务:
        description: 本次修改的核心焦点，一句话描述最主要的修改任务
        type: string
      硬性约束:
        description: 必须严格遵守的约束条件，确保不违反基本规则
        type: array
        items:
          type: string
      修改指导:
        description: 具体的修改指导说明，告诉G2如何执行修改
        type: string
      保护要素:
        description: 原作品中必须保持不变的核心元素
        type: array
        items:
          type: string
      修改范围:
        description: 建议的修改范围和程度，控制修改的幅度
        enum:
        - 最小化修改
        - 局部调整
        - 重点修改
        type: string
    required:
    - 核心任务
    - 硬性约束
    - 修改指导
    - 保护要素
    - 修改范围
    type: object
structured_output_enabled: true
```

### **直接复制版本（JSON格式）**
在Dify界面中填入Schema配置框时，请直接复制以下JSON内容：

```json
{
  "type": "object",
  "properties": {
    "核心任务": {
      "type": "string",
      "description": "本次修改的核心焦点，一句话描述最主要的修改任务"
    },
    "硬性约束": {
      "type": "array",
      "description": "必须严格遵守的约束条件，确保不违反基本规则",
      "items": {
        "type": "string"
      }
    },
    "修改指导": {
      "type": "string",
      "description": "具体的修改指导说明，告诉G2如何执行修改"
    },
    "保护要素": {
      "type": "array",
      "description": "原作品中必须保持不变的核心元素",
      "items": {
        "type": "string"
      }
    },
    "修改范围": {
      "type": "string",
      "description": "建议的修改范围和程度，控制修改的幅度",
      "enum": ["最小化修改", "局部调整", "重点修改"]
    }
  },
  "required": ["核心任务", "硬性约束", "修改指导", "保护要素", "修改范围"],
  "additionalProperties": false
}
```

### **字段功能说明**

| 字段名 | 类型 | 功能 | 设计理由 |
|--------|------|------|----------|
| 核心任务 | string | 明确修改重点 | 让G2聚焦最主要问题，避免盲目修改 |
| 硬性约束 | array | 确保规则遵守 | 防止修改过程中违反基本约束（80字限制等） |
| 修改指导 | string | 具体操作指令 | 提供明确的"如何改"的指导 |
| 保护要素 | array | 防止过度修改 | 明确哪些部分不能改，保持原作精神 |
| 修改范围 | enum | 控制修改程度 | 确保修改幅度合理，符合对抗原则 |

## 📊 输出示例

### **场景1: 无错误微调**

**D1输入**:
```json
{
  "最终裁决": "驳回",
  "结构完整性": "合规",
  "引文验证状态": "通过",
  "风格保真度": 0.65,
  "证据充足度": "中",
  "错误码": "NO_ERROR",
  "改进建议": "整体质量良好，建议在某些词汇选择上更加精确，以提升表达的深度"
}
```

**P节点输出**:
```json
{
  "核心任务": "基于改进建议进行词汇精确度微调",
  "硬性约束": [
    "正文字数严格≤80字（不含标题和引文）",
    "保持现有的所有结构和格式"
  ],
  "修改指导": "对个别词汇进行更精确的选择，提升表达深度，保持整体风格和意境不变",
  "保护要素": [
    "保持诗歌的完整结构",
    "保持现有的引文和标题",
    "保持现有的风格特色和意境"
  ],
  "修改范围": "最小化修改"
}
```

### **场景2: 引文格式错误 + 风格保真度低**

**D1输入**:
```json
{
  "最终裁决": "驳回",
  "结构完整性": "合规",
  "引文验证状态": "失败", 
  "风格保真度": 0.3,
  "证据充足度": "中",
  "错误码": "CITATION_FORMAT_INVALID",
  "改进建议": "引文格式错误，需要修正为标准格式；诗歌风格过于现代，缺乏古典韵味"
}
```

**P节点输出**:
```json
{
  "核心任务": "修正引文格式并提升诗歌的古典韵味",
  "硬性约束": [
    "正文字数严格≤80字（不含标题和引文）",
    "使用标准引文格式：《作品》·作者·出处",
    "保持标题格式规范"
  ],
  "修改指导": "将引文格式修正为标准格式，同时在诗歌语言中融入更多古典意象和典雅表达，提升整体古典文化氛围",
  "保护要素": [
    "保持原诗的情感表达核心",
    "保持现代语言的可读性", 
    "保持诗歌的整体结构"
  ],
  "修改范围": "局部调整"
}
```

### **场景3: 篇幅超限**

**D1输入**:
```json
{
  "最终裁决": "驳回",
  "结构完整性": "不合规",
  "引文验证状态": "通过",
  "风格保真度": 0.6,
  "证据充足度": "高", 
  "错误码": "LENGTH_EXCEEDS",
  "改进建议": "正文字数超出80字限制，需要精简表达"
}
```

**P节点输出**:
```json
{
  "核心任务": "精简诗歌正文，控制在80字以内",
  "硬性约束": [
    "正文字数严格≤80字（不含标题和引文）",
    "保持引文格式不变",
    "保持标题格式不变"
  ],
  "修改指导": "通过删减冗余词语、合并相近表达、使用更精练的诗歌语言来压缩篇幅，确保每个字都有明确价值",
  "保护要素": [
    "保持诗歌的核心意象", 
    "保持情感表达的完整性",
    "保持诗歌的韵律感"
  ],
  "修改范围": "最小化修改"
}
```

### **场景4: 风格保真度过低**

**D1输入**:
```json
{
  "最终裁决": "驳回",
  "结构完整性": "合规",
  "引文验证状态": "通过",
  "风格保真度": 0.25,
  "证据充足度": "中",
  "错误码": "STYLE_FAITHFULNESS_LOW",
  "改进建议": "诗歌风格与吴任几作品差异过大，需要更贴近参考风格"
}
```

**P节点输出**:
```json
{
  "核心任务": "调整诗歌风格，更贴近吴任几的创作特色",
  "硬性约束": [
    "正文字数严格≤80字（不含标题和引文）",
    "保持引文和标题格式不变"
  ],
  "修改指导": "参考吴任几的语言特色，采用更加典雅而略带忧郁的表达方式，增加哲思性的意象，使用更贴近传统文人的情感表达模式",
  "保护要素": [
    "保持诗歌的基本内容框架",
    "保持引文与正文的呼应关系"
  ],
  "修改范围": "重点修改"
}
```

## 🔧 G2节点集成方案

### **G2新提示词模板**

```yaml
System提示词:
你是AI诗人"陆家明"的修改专家。基于专门的修改指导进行精确优化。

**修改任务**: {{#P_node.output.核心任务#}}

**必须遵守**: 
{{#P_node.output.硬性约束#}}

**修改指导**: {{#P_node.output.修改指导#}}

**必须保护**: 
{{#P_node.output.保护要素#}}

**修改程度**: {{#P_node.output.修改范围#}}

**原作品**: {{#G1_output#}}

请基于以上结构化指导进行修改，直接输出修改后的诗歌作品。
```

### **变量引用配置**

```yaml
P节点输入变量:
- D1反馈: {{#D1_node.structured_output#}}
- G1原作: {{#G1_node.text#}}

G2节点输入变量:
- P节点指导: {{#P_node.structured_output#}}
- G1原作: {{#G1_node.text#}}
- 知识库检索: {{#知识库节点.output#}}
```

## ⚡ 效果预期

### **Token效率提升**
- **当前G2**: 77行通用提示词 (≈500+ tokens)
- **优化后G2**: 15行结构化模板 (≈150 tokens)
- **预期减少**: 70%+ Token使用量

### **修改精准性提升**
- **针对性**: 基于具体问题生成专门指导
- **保护性**: 明确保护要素，避免过度修改
- **可控性**: 通过修改范围控制修改程度

### **系统稳定性**
- **约束保证**: 硬性约束确保不违反基本规则
- **回退兼容**: 可快速回退到原有77行提示词
- **监控便利**: 结构化输出便于效果监控

## 🎯 实施建议

### **分阶段验证**
1. **P节点独立测试**: 验证D1→P的转换质量
2. **G2集成测试**: 验证P→G2的指导效果  
3. **端到端测试**: 验证完整D1→P→G2链路
4. **对照实验**: 与现有77行提示词效果对比

### **关键监控指标**
- **转换准确性**: P节点是否正确理解D1反馈
- **指导有效性**: G2是否按P节点指导执行修改
- **约束遵守性**: 修改后是否违反硬性约束
- **质量保持性**: 修改后诗歌质量是否保持或提升

### **风险控制**
- **回滚机制**: 保持原有配置，确保可快速回滚
- **A/B测试**: 并行运行对照组验证效果
- **逐步部署**: 先在G2测试，成功后考虑G3应用

## 📚 参考文献

- [Dify工作流变量系统文档](https://docs.dify.ai/zh-hans/guides/workflow/variables)
- [JSON Schema结构化输出最佳实践](https://docs.dify.ai/zh-hans/learn-more/extended-reading/how-to-use-json-schema-in-dify)
- [陆家明AI诗人基线分析文档](../lugarden_universal/lu_the_poet/)

---

*本设计方案基于双Agent对抗博弈系统的深度分析，专注于prompt层面的智能优化*
*文档版本: v1.4 | 创建时间: 2025-09-05 | 兼容性修正版，适配D节点NO_ERROR场景*
