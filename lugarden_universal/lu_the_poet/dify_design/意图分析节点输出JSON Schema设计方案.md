# 意图分析节点输出JSON Schema设计方案

> **设计版本**: v1.0  
> **目标模型**: GEMINI 2.0 Flash Lite  
> **设计日期**: 2025-09-05  
> **适用场景**: 陆家明AI诗人系统中的用户输入智能解析  
> **节点ID**: 1756961820611  
> **架构地位**: 工作流起点，所有后续节点的数据源头

## 🚀 快速使用指南

**在Dify中配置意图分析节点时，请使用第65-89行的JSON格式内容**，这是可以直接复制到Dify界面的标准JSON Schema格式。

完整配置步骤：
1. 在Dify中创建LLM节点，选择`gemini-2.0-flash-lite`模型
2. 启用"结构化输出"选项  
3. 复制第65-89行的完整JSON内容到Schema配置框中
4. 配置对应的System和User提示词
5. Temperature设置为0.7（适度创造性分析）

## 🎯 设计目标

作为整个工作流的起点，意图分析节点负责将用户的自然语言输入转换为结构化数据，为后续的知识库检索、内容生成和对话处理提供精准的数据驱动。

### **核心功能**
1. **智能经典匹配**：从10个儒家经典中选择最适合的创作依据
2. **主题提取**：从用户复杂表达中提取核心创作意图
3. **情感分析**：判断用户表达的情感倾向
4. **明确度评估**：评估用户表达的明确程度

## 🧠 GEMINI 2.0 Flash Lite兼容性分析

### **模型选择策略**
- **目标模型**: `gemini-2.0-flash-lite`
- **选择理由**: 
  - **速度优化**: 作为工作流入口，需要快速响应
  - **成本效益**: 相比2.5 Pro更经济，适合高频入口节点
  - **中文理解**: 优秀的中文语义理解能力
  - **结构化输出**: 稳定的JSON Schema遵循能力
- **Temperature**: 0.7（平衡创造性分析与准确性）

### **技术特性**
1. **中文字段名**: 减少翻译歧义，直接对应中文概念
2. **扁平化结构**: 4个一级字段，结构简洁清晰
3. **严格枚举**: 所有选择性字段都使用枚举约束
4. **明确描述**: 每个字段都有清晰的功能定义

## 📋 完整JSON Schema定义

### **Schema结构（基于YML实际格式）**
```yaml
structured_output:
  schema:
    properties:
      经典选择:
        enum:
        - 周易
        - 论语
        - 孟子
        - 尚书
        - 礼记
        - 仪礼
        - 周礼
        - 易传
        - 春秋左氏传
        - 春秋谷梁传
        type: string
      创作主题:
        type: string
      情感基调:
        enum:
        - 积极
        - 中性
        - 消极
        type: string
      明确度:
        enum:
        - 明确指定
        - 主题表达
        - 情感倾诉
        - 随意对话
        type: string
    required:
    - 经典选择
    - 创作主题
    - 情感基调
    - 明确度
    type: object
  structured_output_enabled: true
```

### **直接复制版本（JSON格式）**
在Dify界面中填入Schema配置框时，请直接复制以下JSON内容：

```json
{
  "type": "object",
  "properties": {
    "经典选择": {
      "type": "string",
      "enum": [
        "周易",
        "论语", 
        "孟子",
        "尚书",
        "礼记",
        "仪礼",
        "周礼",
        "易传",
        "春秋左氏传",
        "春秋谷梁传"
      ]
    },
    "创作主题": {
      "type": "string"
    },
    "情感基调": {
      "type": "string",
      "enum": ["积极", "中性", "消极"]
    },
    "明确度": {
      "type": "string", 
      "enum": ["明确指定", "主题表达", "情感倾诉", "随意对话"]
    }
  },
  "required": ["经典选择", "创作主题", "情感基调", "明确度"],
  "additionalProperties": false
}
```

## 📊 字段功能说明

### **字段设计逻辑**

| 字段名 | 类型 | 选项数量 | 功能 | 设计理由 |
|--------|------|----------|------|----------|
| 经典选择 | enum | 10个 | 智能匹配儒家经典 | 为知识库检索提供精准方向 |
| 创作主题 | string | 无限制 | 提取核心创作意图 | 保持用户原始表达的灵活性 |
| 情感基调 | enum | 3个 | 情感倾向分析 | 为风格调整提供情感指导 |
| 明确度 | enum | 4个 | 表达明确程度 | 为后续交互策略提供依据 |

### **经典匹配规则**
**10个儒家经典的适用场景**：
- **周易**: 哲学思辨、变化规律、占卜预测相关主题
- **论语**: 人际关系、道德修养、教育智慧相关主题
- **孟子**: 人性善恶、政治理想、社会改革相关主题
- **尚书**: 政治制度、历史事件、治国理政相关主题
- **礼记**: 礼仪制度、社会规范、文化传统相关主题
- **仪礼**: 具体仪式、行为规范、礼制实践相关主题
- **周礼**: 政治体制、官制设计、制度架构相关主题
- **易传**: 易经解释、象征意义、哲学阐释相关主题
- **春秋左氏传**: 历史叙述、政治评论、事件分析相关主题
- **春秋谷梁传**: 历史解释、道德评判、义理阐发相关主题

### **明确度分级标准**
- **明确指定**: 用户明确指出要使用某个经典或有具体要求
- **主题表达**: 用户有明确的创作主题或内容方向
- **情感倾诉**: 用户主要表达情感，主题相对模糊
- **随意对话**: 用户只是随意聊天，没有明确创作意图

## 🔀 数据流向分析

### **输入变量**
- `{{#sys.query#}}` - 用户原始自然语言输入

### **输出变量（供后续节点使用）**
- `{{#1756961820611.structured_output.经典选择#}}` - 匹配的儒家经典
- `{{#1756961820611.structured_output.创作主题#}}` - 提取的核心主题
- `{{#1756961820611.structured_output.情感基调#}}` - 判断的情感倾向
- `{{#1756961820611.structured_output.明确度#}}` - 表达明确程度

### **下游节点影响**
**意图转换节点** (1756963012326):
```yaml
variables:
- value_selector:
  - '1756961820611'
  - structured_output
  value_type: object
  variable: arg1
```

**知识库检索驱动**:
- **风格域检索** (1756699728276): 基于经典选择和情感基调
- **正典域检索** (1756953941881): 基于经典选择的重点检索
- **规则域检索** (1756961775730): 基于经典选择的规则参考

**CHAT1氛围调节**:
```
你的前序环节是用户意图分析器，分析结果如下{{#1756963012326.output#}}
```

## 📊 输出示例

### **场景1: 明确指定经典**
**用户输入**: "请基于《论语》写一首关于师友之道的诗"

**输出**:
```json
{
  "经典选择": "论语",
  "创作主题": "师友之道",
  "情感基调": "积极",
  "明确度": "明确指定"
}
```

### **场景2: 主题表达**
**用户输入**: "最近对人生变化很有感悟，想要表达一些哲学思考"

**输出**:
```json
{
  "经典选择": "周易",
  "创作主题": "人生变化的哲学思考",
  "情感基调": "中性", 
  "明确度": "主题表达"
}
```

### **场景3: 情感倾诉**
**用户输入**: "今天心情很沮丧，感觉很多事情都不顺利"

**输出**:
```json
{
  "经典选择": "孟子",
  "创作主题": "逆境中的心境调适",
  "情感基调": "消极",
  "明确度": "情感倾诉"
}
```

### **场景4: 随意对话**
**用户输入**: "你好，今天天气不错"

**输出**:
```json
{
  "经典选择": "论语", 
  "创作主题": "日常生活感受",
  "情感基调": "积极",
  "明确度": "随意对话"
}
```

## 🔧 系统集成方案

### **提示词配置参考**
```yaml
System提示词:
你是用户意图分析器，需要分析用户的输入，从"周易", "论语", "孟子", "尚书", "礼记", "仪礼", "周礼", "易传", "春秋左氏传", "春秋谷梁传"中，选择最合适的输出。

分析规则：
1. 如果用户明确提到经典名称，直接采用
2. 如果未指定，根据内容判断最适合的经典
3. 提取核心创作主题
4. 判断情感基调

User提示词:
{{#sys.query#}}
```

### **变量传递配置**
```yaml
输入变量:
- 系统查询: {{#sys.query#}}

输出变量配置:
- 节点ID: 1756961820611
- 输出类型: structured_output
- 传递方式: object类型完整传递
```

## ⚡ 性能优化考虑

### **速度优化**
- **模型选择**: Flash Lite确保快速响应（<2秒）
- **Schema简洁**: 4字段扁平结构，解析效率高
- **枚举约束**: 减少模型生成的不确定性

### **准确性保证**
- **Temperature 0.7**: 平衡创造性和准确性
- **严格枚举**: 关键字段使用枚举约束
- **明确描述**: 每个字段都有清晰的判断标准

### **成本控制**
- **入口优化**: 使用成本较低的Flash Lite模型
- **简洁提示词**: 避免过长的system提示词
- **结构化输出**: 减少解析后处理的计算成本

## 🎯 质量监控建议

### **关键监控指标**
- **经典匹配准确性**: 人工评估匹配的合理性
- **主题提取质量**: 主题是否准确反映用户意图
- **情感判断准确性**: 情感基调是否符合用户表达
- **明确度分级准确性**: 分级是否合理区分不同表达类型

### **优化迭代方向**
1. **经典匹配规则细化**: 基于使用数据优化匹配逻辑
2. **主题提取质量提升**: 增加更多示例提升提取准确性
3. **边界情况处理**: 优化模糊输入的处理策略

## 📚 参考信息

### **相关节点**
- **下游节点**: 意图转换(1756963012326)、知识库检索群、CHAT1(1756970904564)
- **数据消费者**: 风格域、正典域、规则域知识库检索
- **影响范围**: 整个工作流的数据驱动起点

### **技术依赖**
- **Dify工作流变量系统**: 用于数据传递
- **GEMINI 2.0 Flash Lite**: 模型API依赖
- **JSON Schema验证**: 确保输出格式正确性

---

*本设计方案基于陆家明AI诗人系统的实际YML配置，确保与生产环境完全一致*  
*文档版本: v1.0 | 创建时间: 2025-09-05 | 基于节点ID 1756961820611的实际配置*
