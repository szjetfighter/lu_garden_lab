# 陆家明AI诗人 - 基线工作流架构分析

## 📊 工作流概览

**应用信息**:
- **应用名称**: 陆家明的周与春秋练习
- **应用模式**: advanced-chat
- **应用图标**: 🤖
- **Dify版本**: 0.4.0

**依赖插件**:
- langgenius/jina:0.0.8 (重排序)
- langgenius/openai:0.2.5 (OpenAI模型)
- langgenius/gemini:0.5.4 (Gemini模型)

## 🔀 节点连接架构

### 主要执行路径

```
用户输入(开始)
    ↓
[变量赋值] → [意图分析LLM] → [意图转换]
    ↓
[三个知识库并行检索: 风格域、正典域、规则域]
    ↓
[知识检索转换] → [G1诗歌创作] → [D1评审] → [条件分支1]
    ↓
True分支: [CHAT3俏皮话] → [直接回复]
False分支: [G2修改] → [D2评审] → [条件分支2]
    ↓
True分支: [CHAT4俏皮话] → [直接回复]
False分支: [G3最终修改] → [CHAT5俏皮话] → [直接回复]
```

### 辅助对话流程

```
[CHAT语气检索] → [语气转换] → [CHAT1氛围调节] → [过渡回复]
    ↓
[CHAT2等待提示] → [继续主流程]
```

## 🎯 核心设计特征

### 1. **三轮迭代机制**
- **第1轮**: G1 → D1 → 发表/驳回判断
- **第2轮**: G2 → D2 → 发表/驳回判断
- **第3轮**: G3 → 强制输出(兜底机制)

### 2. **三域知识库架构**
- **风格域**: dataset_id = 1Y1WQbwVfkwHf+CfRVdWqWVe2lrJ0yLoyYVIYwucnxA0UN2hn0DQlGJtsdXZIlJT
- **正典域**: dataset_id = dqi7IcK7A9tg+J544VDWf8biflTARzG/LIemG8W5A4CaJn7lJP/SzPKFytz2ON6J
- **规则域**: dataset_id = wtBa5CKBmPk0XFg/W/rzdKe5hmjU4qRluehd99lxPz2AfzsJfOC7Db8U3RMXyuoH
- **语气域**: dataset_id = 1Y1WQbwVfkwHf+CfRVdWqWVe2lrJ0yLoyYVIYwucnxA0UN2hn0DQlGJtsdXZIlJT

### 3. **双重路由机制**
- **结构化输出路由**: 基于JSON Schema的"最终裁决"字段
- **精确匹配条件**: `{{structured_output.最终裁决}} == "发表"`

### 4. **会话变量管理**
- **opening**: 固定开场白
- **chattone**: 动态语气检索查询

## ⚠️ 架构复杂度分析

### 节点统计
- **总节点数**: ~40个节点
- **LLM节点**: 10个 (意图分析 + 3G + 2D + 5CHAT)
- **知识检索节点**: 4个
- **模板转换节点**: 6个
- **条件分支节点**: 2个
- **回复节点**: 5个

### 潜在优化点
1. **模板转换节点冗余**: 多个简单的模板转换可合并
2. **CHAT节点功能重叠**: 5个CHAT节点职责相似
3. **路由逻辑复杂**: 多个条件分支增加维护成本

## 📋 节点详细清单

### LLM节点列表
1. **意图分析节点** (1756961820611)
2. **G1** (1756699910424) 
3. **D1** (1756701800237)
4. **G2** (17569669412190)
5. **D2** (17569676735610)
6. **G3** (17569682077130)
7. **CHAT1** (1756970904564)
8. **CHAT2** (17569737246690)
9. **CHAT3** (1756968473773)
10. **CHAT4** (17569687362650)
11. **CHAT5** (17569688353670)

### 知识检索节点列表
1. **风格域知识库检索** (1756699728276)
2. **正典域知识库检索** (1756953941881) 
3. **规则域知识库检索** (1756961775730)
4. **CHAT语气检索** (1756977828986)

## 🎭 开场白设置

```
你好，我是陆家明，陆家花园的主理人

这里是我练习如何模仿吴任几先生写诗的地方

不管你说什么，我都会尝试用一首诗来回复你

我已经准备好了。你想和我聊点儿什么？
```

---
*生成时间: 2025-01-11*
*基于YML版本: 0.4.0*
