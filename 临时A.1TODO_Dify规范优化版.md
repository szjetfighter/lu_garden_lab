# 临时A.1TODO：知识库架构设计与构建（Dify规范优化版）

> **🎯 基于Dify平台能力的实用化A.1任务指导**
> 结合原有A.1任务核心思想 + Dify官方文档规范要求的优化版本

---

## ⚡ **快速执行概述**

**目标**: 在Dify平台构建风格域和正典域两个知识库，为双Agent对抗博弈提供检索支持

**预计时间**: 1-2个工作日  
**关键输出**: 可在Dify工作流中调用的两个知识库 + 配置文档  
**验证标准**: 样本查询命中率>90% + 引文核验准确性>95%

---

## 📋 **任务A.1：知识库架构设计与构建**

### **核心思想**（保留原版）
数据库作为唯一真源（Single Source of Truth），对外导出干净可读的Markdown文本；在Dify内构建风格域与正典域两个独立知识库，为Generator与Discriminator提供差异化检索支持。

### **技术约束**（基于Dify实际能力）
- **文件格式**: Markdown (.md) 优先
- **文件大小**: ≤15MB/文档
- **分段模式**: **父子模式**（Dify推荐，两个域都用）
- **分段长度**: 500 tokens（默认），重叠15%
- **检索方式**: 混合检索 + 重排

---

## 🚀 **子任务A.1.1：风格域知识库构建**

### **数据准备**（简化版）

#### **步骤1：从数据库导出诗歌内容**
```bash
# 目标：从Prisma ZhouPoem表导出48首诗歌
# 输出：zhou_poems_export.json
```

**导出字段映射**:
```json
{
  "title": "诗歌标题", 
  "chapter": "章节（是折枝/观我生/雨木冰）",
  "body": "正文内容(JSON格式)",
  "poet_explanation": "诗人解读",
  "core_theme": "核心主题"
}
```

#### **步骤2：转换为Dify标准Markdown**
**文件命名**: `风格域_{章节}_{诗歌标题}.md`

**Markdown模板**:
```markdown
---
title: "诗歌标题"
chapter: "章节名称" 
core_theme: "核心主题"
classical_echo: "古典回响内容"
problem_solved: "解决的问题"
spiritual_consolation: "精神慰藉"
poet_explanation: true
---

# {诗歌标题}

## 正文
{解析后的诗歌正文，按段分割}

## 诗人解读
{poet_explanation}
```

**分段策略**（符合Dify父子模式）:
- **父文档**: 完整诗作（用于归因锚点）
- **子文档**: 按自然段/诗节分割（实际检索单元）
- **重叠**: 15%（防止语义断裂）

#### **步骤3：YAML Front Matter元数据**
**直接在Markdown文件头部定义**（聚焦诗歌特征）:
```yaml
---
title: "诗歌标题"
chapter: "章节名称"
core_theme: "核心主题"
classical_echo: "古典回响内容"
problem_solved: "解决的问题"
spiritual_consolation: "精神慰藉"
poet_explanation: true
---
```

### **Dify配置**

#### **知识库设置**
- **知识库名称**: `风格域_吴任几诗作`
- **分段模式**: ✅ **父子模式**
- **分段长度**: 500 tokens
- **重叠长度**: 75 tokens (15%)

#### **检索配置**
- **索引方法**: ✅ 高质量索引
- **检索方式**: ✅ 混合检索
- **Top-K**: 5个结果
- **重排**: ✅ 开启

### **验收测试**
**样本查询**:
1. "我们情况差不多" → 应命中对应诗作
2. "观我生" → 应返回该章节诗歌
3. "诗人解读" → 应包含poet_explanation内容

**通过标准**: 3/3查询准确命中 + 正确归因到章节

---

## 🚀 **子任务A.1.2：正典域知识库构建**

### **数据准备**（实用版）

#### **步骤1：获取简体正典文本**
**来源**: [维基文库简体版](https://zh.wikisource.org/zh-hans/)
- 周易：https://zh.wikisource.org/zh-hans/周易
- 春秋公羊传：https://zh.wikisource.org/zh-hans/春秋公羊传  
- 孟子：https://zh.wikisource.org/zh-hans/孟子

**文本处理**:
- 繁体→简体（OpenCC）
- 清理HTML标签和格式符号
- 统一篇章命名：`{书目}·{篇章}`

#### **步骤2：创建Dify标准文档**
**文件命名**: `正典域_{书目}_{篇章}.md`

**Markdown模板**:
```markdown
---
book: "书目名称"
chapter: "篇章名称"
locator: "书目·篇章·具体位置"
---

# {书目}·{篇章}

## 原文
{按句/节分段的原文内容}
```

**分段策略**（父子模式）:
- **父文档**: 篇章级（如"周易·系辞上"）
- **子文档**: 句/节级（如具体卦辞、爻辞）
- **命名规范**: `{书目}·{篇章}·{节次}`

#### **步骤3：YAML Front Matter元数据**
**直接在Markdown文件头部定义**（聚焦核验需要）:
```yaml
---
book: "周易"
chapter: "系辞上"
locator: "周易·系辞上·第一章"
---
```

### **Dify配置**

#### **知识库设置**
- **知识库名称**: `正典域_三书合集`
- **分段模式**: ✅ **父子模式**
- **分段长度**: 300 tokens（正典文本较短）
- **重叠长度**: 45 tokens (15%)

#### **检索配置**
- **索引方法**: ✅ 高质量索引
- **检索方式**: ✅ 混合检索
- **Top-K**: 8个结果（支持跨书目检索）
- **重排**: ✅ 开启

### **验收测试**
**引文核验样本**:
1. "天行健，君子以自强不息" → 应命中"周易·乾卦"
2. "孟子见梁惠王" → 应命中"孟子·梁惠王上"
3. "春王正月" → 应命中"春秋公羊传"相关篇章

**通过标准**: 引文核验准确率>95% + 正确归因到"书目·篇章"

---

## 📊 **整体验收与交付**

### **最终交付物**
- [ ] **风格域知识库**: 48首诗歌Markdown + Dify配置记录
- [ ] **正典域知识库**: 三书正典Markdown + Dify配置记录  
- [ ] **配置文档**: 分段参数、检索设置、测试结果
- [ ] **验证报告**: 样本查询结果 + 引文核验准确率

### **集成准备**
- [ ] **API访问**: 获取知识库API调用方式
- [ ] **工作流集成点**: 确认Generator/Discriminator如何调用
- [ ] **多库检索配置**: 验证同时查询两个知识库的方法

### **风险控制**
- ⚠️ **文本质量**: 简体转换和格式清理可能影响检索
- ⚠️ **分段效果**: 父子模式分段是否符合语义完整性
- ⚠️ **检索精度**: Top-K和重排参数需要根据实际效果调优

---

## 🛠️ **实际执行检查清单**

### **准备工作**
- [ ] 确认Dify账号和权限
- [ ] 准备OpenCC繁简转换工具
- [ ] 建立本地工作目录：`lugarden_universal/lu_the_poet/corpus/`

### **A.1.1执行**
- [ ] 导出ZhouPoem数据 → JSON文件
- [ ] 转换为48个Markdown文件
- [ ] 在Dify创建"风格域_吴任几诗作"知识库
- [ ] 配置父子模式分段（500 tokens, 15%重叠）
- [ ] 上传Markdown文件并设置元数据
- [ ] 配置混合检索+重排
- [ ] 执行3个样本查询测试

### **A.1.2执行**  
- [ ] 从维基文库获取三书文本
- [ ] 清理并转换为标准Markdown
- [ ] 在Dify创建"正典域_三书合集"知识库
- [ ] 配置父子模式分段（300 tokens, 15%重叠）
- [ ] 上传文档并设置元数据
- [ ] 配置混合检索+重排（Top-K=8）
- [ ] 执行引文核验测试

### **整合验证**
- [ ] 测试多库联合检索
- [ ] 记录API调用方式
- [ ] 完成配置文档
- [ ] 准备A.2任务的集成接口

---

## 💡 **关键优化点**

1. **分段模式统一**: 两个域都用父子模式（符合Dify推荐）
2. **文件规模控制**: 单文档<15MB，合理分割  
3. **✨元数据YAML化**: 使用YAML Front Matter（Dify原生支持）
4. **检索参数优化**: 基于实际测试结果调整Top-K和权重
5. **质量验证闭环**: 每步都有明确的验收标准

### **🌟 YAML Front Matter方案优势**
- **统一格式**: 全部使用Markdown，无需JSON配置
- **人类可读**: 元数据也是清晰的文本格式
- **版本控制友好**: Git能完美跟踪所有变更
- **Dify原生支持**: 平台自动解析YAML Front Matter
- **维护便利**: 元数据和内容在同一文件，便于管理

---

**📅 预期完成时间**: 1-2个工作日  
**🎯 成功标志**: Generator能获得风格上下文 + Discriminator能验证引文真实性  
**🔄 下一步**: 基于配置好的知识库构建A.2双Agent工作流

---
*本临时TODO基于Dify平台实际能力优化，保持原A.1核心目标的同时提供可执行的技术路径*
